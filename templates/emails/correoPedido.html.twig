{# Usamos el bloque 'texto' para ser consistentes con las otras plantillas modernas #}
{% extends "emails/plantillaMail.html.twig" %}

{% block texto %}
    <h2>¡Gracias por tu pedido, {{ pedido.contacto.nombre }}!</h2>
    <p>Hemos recibido correctamente tu solicitud de presupuesto con el número <strong>{{ pedido.nombre }}</strong>. Nuestro equipo ya está trabajando en ello.</p>
    <br>

    {# 1. Aviso importante rediseñado #}
    <div style="background-color: #fffbe6; border: 1px solid #ffe58f; padding: 15px; margin-top: 20px; border-radius: 4px;">
        <h3 style="margin-top: 0;">¡Información Importante!</h3>
        <p>Este es un resumen de tu solicitud. <strong>Por favor, NO realices ningún pago todavía.</strong> En breve, nuestro equipo comercial te enviará el presupuesto definitivo con los plazos de entrega y las instrucciones para el pago.</p>
    </div>
    <br>

    {# 2. Resumen del pedido en una tabla limpia #}
    <h3>Resumen de tu Solicitud</h3>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px;">
        <thead>
        <tr style="background-color: #f2f2f2; text-align: left;">
            <th style="padding: 10px; border: 1px solid #ddd;">Producto</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Precio Ud.</th>
            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Cant.</th>
            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Total</th>
        </tr>
        </thead>
        <tbody>
        {% for group_key, lineas_in_group in grouped_lines %}
            {# Fila para las personalizaciones de este grupo #}
            <tr style="background-color: #fafafa;">
                <td colspan="4" style="padding: 10px; border: 1px solid #ddd; border-top: 2px solid #007bff;">
                    <strong>Personalizaciones:</strong>
                    {% set personalizacion_display = lineas_in_group|first.personalizacion %}
                    <div style="font-size: 0.9em; color: #555;">{{ personalizacion_display is not empty ? personalizacion_display|nl2br : 'Sin personalización' }}</div>
                </td>
            </tr>

            {# Filas para los productos de este grupo #}
            {% for linea in lineas_in_group %}
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        {{ linea.producto.modelo.nombre | capitalize }}
                        <br><small style="color: #777;">Talla: {{ linea.producto.talla }} | Color: {{ linea.producto.color | capitalize }}</small>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ linea.precio | number_format(2, ',', '.') }} €</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ linea.cantidad }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">{{ (linea.precio * linea.cantidad) | number_format(2, ',', '.') }} €</td>
                </tr>
            {% endfor %}
        {% endfor %}
        </tbody>
        <tfoot>
        {# Sección de totales #}
        <tr>
            <td colspan="2"></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;"><strong>Subtotal:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ pedido.subTotal | number_format(2, ',', '.') }} €</td>
        </tr>
        <tr>
            <td colspan="2"></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;"><strong>Envío:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ pedido.envio | number_format(2, ',', '.') }} €</td>
        </tr>
        <tr>
            <td colspan="2"></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;"><strong>IVA:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ pedido.iva | number_format(2, ',', '.') }} €</td>
        </tr>
        <tr style="font-weight: bold; background-color: #f2f2f2;">
            <td colspan="2"></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;"><strong>TOTAL (Estimado):</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ pedido.total | number_format(2, ',', '.') }} €</td>
        </tr>
        </tfoot>
    </table>

    {# 3. Próximos pasos claros #}
    <h3>Próximos Pasos</h3>
    <ol style="line-height: 1.8;">
        <li>Nuestro equipo revisará tu pedido para confirmar el stock y los detalles de personalización.</li>
        <li>A la mayor brevedad posible, recibirás un <strong>segundo correo</strong> con el presupuesto definitivo, las fechas de entrega y las instrucciones para el pago.</li>
    </ol>
    <p>Si tienes cualquier duda, puedes responder a este correo.</p>
    <br>
    <p>Gracias por tu solicitud.</p>
{% endblock %}