{# templates/web/product/partials/_gallery.html.twig #}

{# 1. PREPARACIÓN DE DATOS: Unificamos todas las imágenes en una lista #}
{% set todasLasImagenes = [] %}

{# A. Imagen Principal (Prioridad: SonataMedia > URL externa) #}
{% if modelo.imagen %}
    {% set todasLasImagenes = todasLasImagenes|merge([sonata_path(modelo.imagen, 'wide')]) %}
{% elseif modelo.urlImage %}
    {% set todasLasImagenes = todasLasImagenes|merge([modelo.urlImage]) %}
{% endif %}

{# B. Imagen Infantil #}
{% if modelo.childImage %}
    {% set todasLasImagenes = todasLasImagenes|merge([modelo.childImage]) %}
{% endif %}

{# C. Otras Imágenes (Separadas por comas) #}
{% if modelo.otherImages %}
    {% for img in modelo.otherImages|split(',') %}
        {% if img|trim is not empty %}
            {% set todasLasImagenes = todasLasImagenes|merge([img|trim]) %}
        {% endif %}
    {% endfor %}
{% endif %}

{# D. Imágenes de Detalle #}
{% if modelo.detailsImages %}
    {% for img in modelo.detailsImages|split(',') %}
        {% if img|trim is not empty %}
            {% set todasLasImagenes = todasLasImagenes|merge([img|trim]) %}
        {% endif %}
    {% endfor %}
{% endif %}


{# 2. VISTA ESCRITORIO (Grid) - Se oculta en móviles #}
<div class="hidden-xs">
    <div class="row">
        {# Si hay más de 1 imagen, la principal ocupa la mitad (col-lg-6), si no, todo el ancho (col-lg-12) #}
        {% set mainColClass = (todasLasImagenes|length > 1) ? 'col-lg-6' : 'col-lg-12' %}

        {# Renderizamos la primera imagen (Principal) #}
        {% if todasLasImagenes|length > 0 %}
            <div class="{{ mainColClass }}">
                <div class="row" style="padding: 5px">
                    <img class="imagenProducto"
                         style="width: 100%; height: auto"
                         id="imagen-producto"
                         src="{{ todasLasImagenes[0] }}"
                         alt="{{ modelo.nombre }}">
                </div>
            </div>
        {% endif %}

        {# Renderizamos el resto de imágenes en rejilla #}
        {% for img in todasLasImagenes|slice(1) %}
            <div class="col-lg-6">
                <div class="row" style="padding: 5px">
                    <img class="imagenProducto"
                         style="width: 100%; height: auto"
                         src="{{ img }}"
                         alt="{{ modelo.nombre }} - vista {{ loop.index }}">
                </div>
            </div>
        {% endfor %}
    </div>
</div>


{# 3. VISTA MÓVIL (Carrusel) - Solo visible en móviles #}
<div class="visible-xs">
    {% if todasLasImagenes|length > 0 %}
        <div id="carousel-producto-movil" class="carousel slide" data-ride="carousel" data-interval="false" style="margin-bottom: 20px;">

            {# Indicadores (Puntos abajo) #}
            <ol class="carousel-indicators" style="bottom: -20px;">
                {% for img in todasLasImagenes %}
                    <li data-target="#carousel-producto-movil"
                        data-slide-to="{{ loop.index0 }}"
                        class="{{ loop.first ? 'active' : '' }}"
                        style="border-color: #666; background-color: {{ loop.first ? 'transparent' : 'transparent' }};">
                    </li>
                {% endfor %}
            </ol>

            {# Diapositivas #}
            <div class="carousel-inner" role="listbox">
                {% for img in todasLasImagenes %}
                    <div class="item {{ loop.first ? 'active' : '' }}">
                        <img src="{{ img }}" alt="{{ modelo.nombre }}" style="display: block; width: 100%; height: auto;">
                    </div>
                {% endfor %}
            </div>

            {# Flechas de control (Opcional, ayudan a la usabilidad) #}
            <a class="left carousel-control" href="#carousel-producto-movil" role="button" data-slide="prev" style="background: none; color: #333; text-shadow: none; opacity: 0.5;">
                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="left: 0;"></span>
            </a>
            <a class="right carousel-control" href="#carousel-producto-movil" role="button" data-slide="next" style="background: none; color: #333; text-shadow: none; opacity: 0.5;">
                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="right: 0;"></span>
            </a>
        </div>

        {# Script para soporte TÁCTIL (Swipe) en el carrusel #}
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                var carousel = document.getElementById("carousel-producto-movil");
                var startX;

                // Detectar inicio del toque
                carousel.addEventListener("touchstart", function(e) {
                    startX = e.touches[0].clientX;
                }, {passive: true});

                // Detectar fin del toque y calcular dirección
                carousel.addEventListener("touchend", function(e) {
                    if (!startX) return;
                    var endX = e.changedTouches[0].clientX;
                    var diffX = startX - endX;

                    // Si el deslizamiento es mayor a 50px
                    if (Math.abs(diffX) > 50) {
                        if (diffX > 0) {
                            // Deslizar izquierda -> Siguiente
                            $(carousel).carousel('next');
                        } else {
                            // Deslizar derecha -> Anterior
                            $(carousel).carousel('prev');
                        }
                    }
                    startX = null;
                }, {passive: true});
            });
        </script>

        {# Estilos específicos para los puntos activos (color naranja corporativo) #}
        {# Estilos específicos para los puntos activos (color naranja corporativo) #}
        <style>
            /* Forzamos el color con !important para ganar a Bootstrap */
            #carousel-producto-movil .carousel-indicators .active {
                background-color: #ff9933 !important;
                border-color: #ff9933 !important;
                width: 12px;
                height: 12px;
                margin: 0;
                opacity: 1; /* Aseguramos que no sea transparente */
            }
            #carousel-producto-movil .item {
                padding: 0; !important;
            }

            /* Estilo para los puntos inactivos */
            #carousel-producto-movil .carousel-indicators li {
                border-color: #999;
                background-color: transparent;
                margin: 0 2px;
            }
        </style>
    {% endif %}
</div>