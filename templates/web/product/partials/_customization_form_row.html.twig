{# templates/web/product/partials/_customization_form_row.html.twig #}
{# Esta plantilla ahora utiliza atributos de datos para la lógica de JavaScript #}

<div class="personalization-row" id="personalization-row-{{ nPersonalizaciones }}" style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px; position: relative;">

    <button type="button" class="close remove-personalization-row" aria-label="Close" style="position: absolute; top: 15px; right: 15px;">
        <span aria-hidden="true">&times;</span>
    </button>
    <br>
    <div class="row">

        {# --- INICIO DE LA MEJORA --- #}
        <div class="col-sm-12" style="margin-bottom: 15px;">
{#            <label>Elige una opción de personalización:</label>#}
            <select class="form-control personalizacion-selector">
                <option value="-1">Crear un nuevo diseño...</option>
                {% if personalizacionesCarrito is not empty %}
                    <optgroup label="Usar un diseño existente del carrito">
                        {% for trabajo in personalizacionesCarrito %}
                            <option value="{{ trabajo.identificadorTrabajo }}">{{ trabajo }}</option>
                        {% endfor %}
                    </optgroup>
                {% endif %}
            </select>
        </div>
        {# --- FIN DE LA MEJORA --- #}

        <div class="nuevaPersonalizacionContainer">
            <div class="col-md-3 col-sm-6">
                <label>Técnica de Estampado</label>
                <select class="form-control personalizacionTipo">
                    <option value="">Selecciona una técnica...</option>
                    {# Se itera sobre las 'tecnicas' (ModeloHasTecnicasEstampado) que pasa el controlador #}
                    {% for tecnica in tecnicas %}
                        {# Se extraen las áreas y se guardan en atributos data-* #}
                        {% set areas = tecnica.areas|map(a => a.area) %}
                        <option value="{{ tecnica.personalizacion.codigo }}"
                                data-max-colores="{% if tecnica.maxColores >0 %}{{ tecnica.maxColores }}{% else %}{{ tecnica.personalizacion.numeroMaximoColores }}{% endif %}"
                                data-areas="{{ areas|json_encode }}">
                            {{ tecnica.personalizacion.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2 col-sm-6 tintas-container" style="display: none;">
                <label>Nº Tintas</label>
                <input type="number" class="form-control tintas" min="1" value="1">
            </div>

            <div class="col-md-3 col-sm-6 ubicacion-container">
                <label for="personalizacion-ubicacion-{{ nPersonalizaciones }}">Ubicación</label>
                <select id="personalizacion-ubicacion-{{ nPersonalizaciones }}" class="form-control ubicacion">
                    {# El JavaScript se encargará de rellenar este desplegable #}
                </select>
            </div>

            <div class="col-md-4 col-sm-6">
                <label>Tu Diseño (Opcional)</label>
                <span class="btn btn-success fileinput-button">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>Seleccionar archivo...</span>
                    <input class="file-upload-input" type="file" name="files[]">
                </span>
                <div class="progress" style="margin-top: 5px; margin-bottom: 5px; height: 10px;"><div class="progress-bar progress-bar-success"></div></div>
                <div class="files"></div>
            </div>

            <div class="col-sm-12" style="margin-top: 15px;">
                <textarea class="form-control observaciones" rows="2" placeholder="Observaciones sobre este diseño..."></textarea>
            </div>
        </div>
    </div>
</div>

