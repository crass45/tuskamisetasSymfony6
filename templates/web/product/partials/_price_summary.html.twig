{% set totalProductos = presupuesto.getCantidadProductos() %}
{% set precioUnidad = presupuesto.getPrecioUnidad(app.user) %}
{% set precioSubTotal = presupuesto.getPrecioTotal(app.user) %}
{% set ivaAplicar = precioSubTotal * (ivaGeneral / 100) %}
{% set precioTotal = precioSubTotal + ivaAplicar %}

<fieldset class="product-information borde_naranja" style="padding: 10px; display: block; margin-bottom: 0px;">
    <legend><b><span class="numberCircle">3</span> {% trans %}TU PEDIDO{% endtrans %}</b></legend>

    {% if cantidadEnCarrito is defined and cantidadEnCarrito > 0 %}
        <div class="alert alert-info" style="font-size: 12px; padding: 10px; margin-bottom: 10px;">
            <i class="fa fa-info-circle"></i> El precio se recalculará en el carrito para incluir los <strong>{{ cantidadEnCarrito }} productos</strong> que ya tienes.
        </div>
    {% endif %}

    <table class="table-responsive" style="width: 100%">
        <thead>
        <tr><td colspan="2" style="text-align: center; background-color: #f5f5f5"><b>{% trans %}RESUMEN{% endtrans %}</b></td></tr>
        </thead>
        <tbody>
        <tr>
            <td>{% trans %}Total de Productos{% endtrans %}</td>
            <td style="text-align: right" id="div_precio_total_productos"><b>{{ totalProductos }} uds</b></td>
        </tr>
        <tr>
            <td>{% trans %}Precio por unidad{% endtrans %}</td>
            <td style="text-align: right" id="div_precio_precio_unidad"><b class="precio-unidad-valor">{{ precioUnidad | number_format(2, ',', '.') }}€</b></td>
        </tr>
        <tr>
            <td>{% trans %}Subtotal{% endtrans %}</td>
            <td style="text-align: right"><b>{{ precioSubTotal | number_format(2, ',', '.') }}€</b></td>
        </tr>

        {# --- INICIO DE LA LÓGICA DE ADMIN --- #}
        {% if is_granted('ROLE_ADMIN') %}
            <tr>
                <td>{% trans %}Serigrafia Por unidad{% endtrans %}</td>
                <td style="text-align: right"><b>{{ presupuesto.precioSerigrafiaPorUnidad | number_format(2, ',', '.') }}€</b></td>
            </tr>
            <tr>
                <td>{% trans %}Total Serigrafia{% endtrans %}</td>
                <td style="text-align: right"><b>{{ presupuesto.totalTrabajo | number_format(2, ',', '.') }}€</b></td>
            </tr>
{#            <tr>#}
{#                <td>{% trans %}Gastos de Envío (a Peninsula){% endtrans %}</td>#}
{#                <td style="text-align: right"><b>{{ precioGastos | number_format(2, ',', '.') }}€</b></td>#}
{#            </tr>#}
        {% endif %}
        {# --- FIN DE LA LÓGICA DE ADMIN --- #}

        <tr>
            <td>IVA ({{ ivaGeneral }}%)</td> {# Asumimos que ivaGeneral ya está en formato 21, no 0.21 #}
            <td style="text-align: right">
                {% if is_granted('ROLE_ADMIN') %}
                    <b>{{ ((precioSubTotal) * (ivaGeneral)) | number_format(2, ',', '.') }}€</b>
                {% else %}
                    <b>{{ ivaAplicar | number_format(2, ',', '.') }}€</b>
                {% endif %}
            </td>
        </tr>
        </tbody>
        <tfoot>
        <tr style="font-size: 1.2em;">
            <td><b>{% trans %}TOTAL{% endtrans %}</b></td>
            <td style="text-align: right">
                {% if is_granted('ROLE_ADMIN') %}
                    <b>{{ ((precioSubTotal ) * (1 + (ivaGeneral / 100))) | number_format(2, ',', '.') }}€</b>
                {% else %}
                    <b>{{ precioTotal | number_format(2, ',', '.') }}€</b>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <div class="text-center">
                    {% if totalProductos > 0 %}
                        <form action="{{ path('app_cart_add', {'_locale': app.request.locale}) }}" method="post">
                            <button id="addAMiPEdido" class="button">
                                <span class="glyphicon glyphicon-shopping-cart" style="margin: 0"></span>
                                {% trans %}Añadir al Carrito{% endtrans %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </td>
        </tr>
        </tfoot>
    </table>
</fieldset>

<script>
    $('#addAMiPEdido').click(function (e) {
        if (typeof gtag === 'function') {
            gtag("event", "add_to_cart", {
                currency: "EUR",
                value: "{{ precioTotal|number_format(2, '.', '') }}", // Enviamos siempre el precio de cliente a GTAG
                items: [
                    // ... tu lógica de GTAG se mantiene ...
                ]
            });
        }
    });
</script>