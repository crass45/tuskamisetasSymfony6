{# templates/web/product/partials/_details_panel.html.twig #}
{# Este fichero contiene el contenido de tu antiguo 'productoFichaDerecha2.html.twig', migrado. #}

{#<div class="product-information"><!--/product-information-->#}
    <div class="hidden-xs">
        <h1 style="font-size: 28px; margin: 0px;" itemprop="name">{{ modelo.nombre | upper }}</h1>
        <p itemprop="name">
            {#            <a style="color: black; font-size: 18px" href="{{ path('app_catalog_listing', {'_locale': app.request.locale, 'slug': modelo.fabricante.nombreUrl}) }}"> #}
            <a style="color: black; font-size: 18px" href="{{ path('app_catalog_resolver', {'_locale': app.request.locale, 'slug': modelo.fabricante.nombreUrl}) }}">
                {{ modelo.fabricante.nombre }}
            </a>
        </p>
        {% if modelo.familia %}
            <h2 style="font-size: 14px; margin: 0px;">{{ modelo.familia }}</h2>
        {% endif %}
        <p><b>REF:</b> {{ modelo.referencia }}</p>
    </div>

    <p itemprop="description"><b>{% trans %}Descripción{% endtrans %}: </b>{{ modelo.descripcion | format_description }}</p>
    <p>{{ modelo.descripcionTuskamisetas | format_description }}</p>

    <p itemprop="offers" itemscope itemtype="http://schema.org/AggregateOffer"><b>{% trans %}Precio{% endtrans %}
            :</b> {% trans %}Desde{% endtrans %} <span
                itemprop="lowPrice"
                content="{{ modelo.getPrecioUnidad(app.user) | number_format(2, '.', ',') }}"> {{ modelo.getPrecioUnidad(app.user) | number_format(2, ',', '.') }}</span>
        <span itemprop="highPrice"
              content="{{ modelo.getPrecioCantidadColor(1, app.user) | number_format(2, '.', ',') }}"></span>€
        <meta itemprop="priceCurrency" content="EUR"/>
        <span itemprop="seller" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="TusKamisetas"/>
        </span>
        <meta itemprop="availability" content="InStock"/>
        <meta itemprop="url"
              content="{{ url('app_product_detail', {'_locale': app.request.locale, 'slug': modelo.nombreUrl}) }}"/>
    </p>

{#    #}{# --- INICIO DE LA CORRECCIÓN --- #}
{#    #}{# Volvemos a calcular la condición para saber si estamos en la vista compleja #}
{#    {% set hasExtraImages = modelo.childImage or (modelo.otherImages and modelo.otherImages|split(',')|filter(img => img is not empty)|length > 0) or (modelo.detailsImages and modelo.detailsImages|split(',')|filter(img => img is not empty)|length > 0) %}#}

{#    {% if hasExtraImages %}#}
        <div class="colores">
            <div style="text-align: center; margin-bottom: 30px">
                {% for productoColor in modelo.getColoresProductos() %}

                    <div class=" colorProductoPresupuesto {{ productoColor.color.id }}"
                            {% if productoColor.viewsImages!=null %}
                                data-toggle="modal" data-target="#fotos-detalle-modal" data-imagenes="{{ productoColor.viewsImages }}"
                            {% endif %}
                            {% if (productoColor.imagenDescargada) %}
                                data-imagen="{{ sonata_path(productoColor.imagen, 'mini') }}"
                            {% else %}
                                data-imagen="{{ productoColor.modelo.urlImage }}"
                            {% endif %}
                         data-modelo="{{ productoColor.modelo.id }}"
                         data-color="{{ productoColor.color.id }}"
                         style="display: inline-block; position: relative;">
                        <a data-toggle="tooltip" title="{{ productoColor.color.nombre |upper }}"
                           style="height: 100%; width: 100%; display: inline-block">
                            {#                            {% if modelo.isTallaNino(productoColor.color) %} #}
                            {% if productoColor.isTallaNino() %}
                                <span style="position: absolute; bottom: 0; right: 0" class="smallCircle">
                                    <i class="fa fa-child" aria-hidden="true"
                                       style="height: 16px; width: 16px; color: white"
                                       title="Tallas infantiles disponibles" name="Tallas infantiles disponibles"></i>
                                        </span>
                            {% endif %}
                            {% if (productoColor.urlImage is defined and productoColor.urlImage != "") or productoColor.imagenDescargada %}
                                <img
                                        class="  {{ productoColor.color.id }} lazy"
                                        src="{{ asset('images/dummy40.png') }}"
                                        {% if (productoColor.imagenDescargada) %}
                                            data-src="{{ sonata_path(productoColor.imagen, 'mini') }}"
                                            data-imagen="{{ sonata_path(productoColor.imagen, 'wide') }}"
                                        {% else %}
                                            data-src="{{ productoColor.urlImage }}"
                                            data-imagen="{{ productoColor.urlImage }}"
                                        {% endif %}

                                        data-modelo="{{ productoColor.modelo.id }}"
                                        data-color="{{ productoColor.color.id }}"
                                        style="width: 40px; height: auto;display: inline-block; border: 1px solid #c8c6c6;"
                                        alt="{{ modelo.nombre }} {{ productoColor.color.nombre }}"
                                        title="{{ modelo.nombre }} {{ productoColor.color.nombre }}">
                            {% else %}
                                <div class="  {{ productoColor.color.id }}"
                                     src="{{ productoColor.urlImage }}"
                                     data-imagen="{{ productoColor.modelo.urlImage }}"
                                     data-modelo="{{ productoColor.modelo.id }}"
                                     data-color="{{ productoColor.color.id }}"
                                     style="width: 40px; height: 40px;display: inline-block; border: 1px solid #c8c6c6;background-color: {{ productoColor.color.codigoRGB }};">
                                    &nbsp;
                                </div>
                            {% endif %}
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
{#    {% endif %}#}


    {% if modelo.composicion %}
        <p><b>{% trans %}Composición{% endtrans %}:</b> {{ modelo.composicion | raw }}</p>
    {% endif %}

    <p><b>{% trans %}Observaciones{% endtrans %}:</b>{{ modelo.observaciones | raw }}</p>
    <p itemprop="offers" itemscope itemtype="http://schema.org/AggregateOffer"><b>{% trans %}Precio{% endtrans %}
            :</b> {% trans %}Desde{% endtrans %} <span
                itemprop="lowPrice"
                content="{{ modelo.getPrecioUnidad(app.user) | number_format(2, '.', ',') }}"> {{ modelo.getPrecioUnidad(app.user) | number_format(2, ',', '.') }}</span>
        <span itemprop="highPrice"
              content="{{ modelo.getPrecioCantidadColor(1, app.user) | number_format(2, '.', ',') }}"></span>€
        <meta itemprop="priceCurrency" content="EUR"/>
        <span itemprop="seller" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="TusKamisetas"/>
        </span>
        <meta itemprop="availability" content="InStock"/>
        <meta itemprop="url"
              content="{{ url('app_product_detail', {'_locale': app.request.locale, 'slug': modelo.nombreUrl}) }}"/>
    </p>


    {% if modelo.getCertificados() %} {# Una forma más corta y limpia de comprobar si no es nulo/vacío #}

        {# Creamos un único contenedor con nuestra nueva clase de Flexbox #}
        <div class="certificados-container">

            {% set certificados = modelo.getCertificados() | split(',') %}
            {% for imagen in certificados %}
                {% if imagen is not empty %} {# Buena práctica: asegurarse de que no hay elementos vacíos #}

                    {# Para cada imagen, creamos un enlace a la propia imagen y le aplicamos la nueva clase #}
                    {#                <a href="{{ imagen }}" target="_blank" title="Ver certificado">#}
                    <img class="certificado-imagen"
                         src="{{ imagen }}"
                         alt="Certificado del producto {{ modelo.nombre }}"/>
                    {#                </a>#}

                {% endif %}
            {% endfor %}

        </div>
    {% endif %}


    <p><b>{% trans %}Tallas{% endtrans %}:</b> {{ modelo.getTallasString() }}</p>


    {# ... (Lógica para la ficha técnica y 'Ver medidas') ... #}
    {% if modelo.getUrlFichaTecnica() != null and modelo.getUrlFichatecnica()!= "" %}
        <div>
            <a rel="nofollow"
               href="{{ (modelo.getUrlFichaTecnica()) }}"
               target="_blank">
                <div class="btn btn-info btn-sm product-info-bt.pdf" style="display: inline-block; width: 100%">
                    {% trans %}
                        Ficha Técnica
                    {% endtrans %}
                </div>
            </a>
        </div>
    {% else %}
            {% if modelo.fichaTecnica != null %}
                <a rel="nofollow"
                   href="{{ (path('sonata_media_download', {'id': modelo.fichaTecnica.id})) }}"
                   target="_blank">
                    <div class="btn btn-info btn-sm product-info-bt.pdf"
                         style="display: inline-block; margin-right: 15px;">
                        {% trans %}
                            Ficha Técnica
                        {% endtrans %}
                    </div>
                </a>
                {% if modelo.getDrawing is defined  and modelo.getDrawing != null %}
                    <div class="btn calculaPresupuesto" style="display: inline-block"
                         data-toggle="modal" data-target="#medidas-talla-modal">{% trans %}Ver medidas{% endtrans %}
                    </div>
                {% endif %}
            {% else %}

                {# Si es JHK MUESTRA EL PANTONE #}
                {% if modelo.proveedor.id ==  3239 %}
                    <a rel="nofollow"
                       href="{{ ('https://www.jhktshirt.com/es/catalogo/datasheet/document/' ~ modelo.referencia |lower)}}"
                       download="Ficha-Tecnica{{ modelo.referencia }}" target="_blank">
                        <div class="btn btn-info btn-sm product-info-bt.pdf" style="display: inline-block">
                            {% trans %}Ficha Técnica{% endtrans %}
                        </div>
                    </a>

                    <a rel="nofollow"
                       href="{{ asset('images/Pantone%20Digital_Colores%20JHK.PDF') }}"
                       target="_blank">
                        <div class="btn btn-info btn-sm product-info-bt.pdf"
                             style="display: inline-block; margin-left: 15px">
                            {% trans %}
                                Equivalencias de Color (Pantone)
                            {% endtrans %}
                        </div>
                    </a>
                {% else %}
                    <div class="btn btn-info btn-bg product-info-bt" style="display: inline-block; width: 100%;"
                         data-toggle="modal" data-target="#medidas-talla-modal">{% trans %}Ver medidas{% endtrans %}
                    </div>
                {% endif %}
        {% endif %}
    {% endif %}




    {% if modelo.getTarif() %}
        <p style="padding-top: 10px"><b>{% trans %}PRECIO POR CANTIDADES{% endtrans %}</b></p>
        {% set incrementos = modelo.getTarif().precios %}
        {% if app.user %}
            {% for grupo in app.user.groups %}
                {% for descuento in grupo.descuentos %}
                    {% if descuento.getTarifaAnterior == modelo.getTarif() %}
                        {% set incrementos = descuento.getTarifa.precios %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endif %}

        {% if modelo.hasColor or modelo.hasBlanco %}
            <div class="table-responsive">
                <table class="table-responsive" style="text-align: center; font-size: 12px;width: 100%; margin-top: 0px">

                    <tr>
                        <td style="border: 1px solid darkgray; background-color: lightgrey;">
                            <b>{% trans %}Adulto{% endtrans %}</b>
                        </td>
                        {% for incremento in incrementos %}

                            <td style="border: 1px solid darkgray; background-color: lightgrey;">
                                <b>
                                    {% if incremento.getCantidadString(modelo) < modelo.pack %}
                                        {{ modelo.pack }}
                                    {% else %}
                                        {{ incremento.getCantidadString(modelo) }}
                                    {% endif %}
                                </b>
                            </td>

                        {% endfor %}
                        {% if modelo.pack > 1 %}
                            <td style="border: 1px solid darkgray; background-color: lightgrey;">
                                <b>1</b>
                            </td>
                        {% endif %}
                    </tr>
                    {% if  modelo.hasBlanco %}
                        <tr>
                            <td style="border: 1px solid darkgray">
                                {% trans %}Blanco{% endtrans %}
                            </td>

                            {% for incremento in incrementos %}
                                <td style="border: 1px solid darkgray; font-size: 10px;">
                                    {% if modelo.proveedor.nombre == "Makito" or modelo.proveedor.nombre == "Cifra" %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadBlancas(modelo.pack, app.user) | number_format(3, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadBlancas(incremento.cantidad, app.user) | number_format(3, ',', '.') }}
                                        {% endif %}
                                    {% else %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadBlancas(modelo.pack, app.user) | number_format(2, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadBlancas(incremento.cantidad, app.user) | number_format(2, ',', '.') }}
                                        {% endif %}
                                    {% endif %}
                                    €
                                </td>
                            {% endfor %}
                            {% if modelo.pack > 1 %}
                                <td style="border: 1px solid darkgray; font-size: 10px;">{{ modelo.getPrecioCantidadBlancas(1,app.user) | number_format(2, ',', '.') }}
                                    €
                                </td>
                            {% endif %}
                        </tr>
                    {% endif %}

                    {% if  modelo.hasColor %}
                        <tr>
                            <td style="border: 1px solid darkgray">
                                {% trans %}Color{% endtrans %}
                            </td>

                            {% for incremento in incrementos %}

                                <td style="border: 1px solid darkgray; font-size: 10px;">
                                    {% if modelo.proveedor.nombre == "Makito" or modelo.proveedor.nombre == "Cifra" %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadColor(modelo.pack, app.user) | number_format(3, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadColor(incremento.cantidad, app.user) | number_format(3, ',', '.') }}
                                        {% endif %}
                                    {% else %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadColor(modelo.pack, app.user) | number_format(2, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadColor(incremento.cantidad, app.user) | number_format(2, ',', '.') }}
                                        {% endif %}
                                    {% endif %}€
                                </td>

                            {% endfor %}
                            {% if modelo.pack > 1 %}
                                <td style="border: 1px solid darkgray; font-size: 10px;">{{ modelo.getPrecioCantidadColor(1, app.user) | number_format(2, ',', '.') }}
                                    €
                                </td>
                            {% endif %}
                        </tr>
                    {% endif %}
                </table>
            </div>
        {% endif %}

        {% if modelo.hasBlancoNino or modelo.hasColorNino %}
            <div class="table-responsive">
                <table class="table-responsive" style="text-align: center; font-size: 12px; width: 100%">

                    <tr>
                        <td style="border: 1px solid darkgray; background-color: lightgrey;">
                            <b>{% trans %}Niños{% endtrans %}</b>
                        </td>
                        {% for incremento in incrementos %}

                            <td style="border: 1px solid darkgray; background-color: lightgrey;">
                                <b>
                                    {% if incremento.getCantidadString(modelo) < modelo.pack %}
                                        {{ modelo.pack }}
                                    {% else %}
                                        {{ incremento.getCantidadString(modelo) }}
                                    {% endif %}
                                </b>
                            </td>

                        {% endfor %}
                        {% if modelo.pack > 1 %}
                            <td style="border: 1px solid darkgray; background-color: lightgrey;">
                                <b>1</b>
                            </td>
                        {% endif %}
                    </tr>
                    {% if modelo.hasBlancoNino > 0 %}
                        <tr>
                            <td style="border: 1px solid darkgray">
                                {% trans %}Blanco{% endtrans %}
                            </td>

                            {% for incremento in incrementos %}

                                <td style="border: 1px solid darkgray; font-size: 10px;">
                                    {% if modelo.proveedor.nombre == "Makito" or modelo.proveedor.nombre == "Cifra" %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadBlancasNino(modelo.pack, app.user) | number_format(3, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadBlancasNino(incremento.cantidad, app.user) | number_format(3, ',', '.') }}
                                        {% endif %}
                                    {% else %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadBlancasNino(modelo.pack, app.user) | number_format(2, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadBlancasNino(incremento.cantidad, app.user) | number_format(2, ',', '.') }}
                                        {% endif %}
                                    {% endif %}
                                    €
                                </td>

                            {% endfor %}
                            {% if modelo.pack > 1 %}
                                <td style="border: 1px solid darkgray; font-size: 10px;">{{ modelo.getPrecioCantidadBlancasNino(1, app.user) | number_format(2, ',', '.') }}
                                    €
                                </td>
                            {% endif %}
                        </tr>
                    {% endif %}

                    {% if modelo.hasColorNino > 0 %}
                        <tr>
                            <td style="border: 1px solid darkgray">
                                {% trans %}Color{% endtrans %}
                            </td>

                            {% for incremento in incrementos %}

                                <td style="border: 1px solid darkgray; font-size: 10px;">
                                    {% if modelo.proveedor.nombre == "Makito" or modelo.proveedor.nombre == "Cifra" %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadColorNino(modelo.pack, app.user) | number_format(3, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadColorNino(incremento.cantidad, app.user) | number_format(3, ',', '.') }}
                                        {% endif %}
                                    {% else %}
                                        {% if incremento.cantidad < modelo.pack %}
                                            {{ modelo.getPrecioCantidadColorNino(modelo.pack, app.user) | number_format(2, ',', '.') }}
                                        {% else %}
                                            {{ modelo.getPrecioCantidadColorNino(incremento.cantidad, app.user) | number_format(2, ',', '.') }}
                                        {% endif %}
                                    {% endif %}
                                    €
                                </td>
                            {% endfor %}
                            {% if modelo.pack > 1 %}
                                <td style="border: 1px solid darkgray; font-size: 10px;">{{ modelo.getPrecioCantidadColorNino(1, app.user) | number_format(2, ',', '.') }}
                                    €
                                </td>
                            {% endif %}
                        </tr>
                    {% endif %}
                    {# <tr> #}
                    {# <td style="border: 1px solid darkgray" colspan="8"> #}
                    {# <p style="font-size: 12px">Los precios pueden variar entre tallas.</p> #}
                    {# </td> #}
                    {# </tr> #}
                </table>
            </div>
        {% endif %}

        {% if modelo.variaPrecioEntreTallas(app.user) %}
            <div style="font-size: 12px">
                Los precios de algunas tallas y/o colores podrían ser distintos a los mostrados en esta tabla.
            </div>
        {% endif %}
    {% endif %}
{#</div>#}

