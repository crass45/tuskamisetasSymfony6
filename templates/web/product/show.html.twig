{# templates/web/product/show.html.twig #}

{% extends "base.html.twig" %}

{% block title %}{{ modelo.tituloSEO|default(modelo.nombre) }} | Tuskamisetas.com{% endblock %}
{% block metaDescription %}{{ modelo.descripcionSEO|default(modelo.descripcion)|striptags|slice(0, 155) }}{% endblock %}

{% block aditionalHead %}
    <style>
        /* --- ESTILOS GENERALES (Galería, Certificados...) --- */
        .certificados-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; padding: 15px 0; margin-top: 20px; border-top: 1px solid #eee; }
        .certificado-imagen { max-height: 40px; width: auto; height: auto; }
        .modal-gallery { display: flex; flex-direction: column; height: 75vh; }
        .gallery-main-view { position: relative; flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; margin-bottom: 15px; background-color: #f8f8f8; border-radius: 4px; }
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.4); color: white; border: none; font-size: 24px; font-weight: bold; cursor: pointer; padding: 10px 15px; border-radius: 50%; transition: background-color 0.2s ease; z-index: 10; opacity: 0; }
        .gallery-main-view:hover .gallery-nav { opacity: 1; }
        .gallery-nav:hover { background-color: rgba(0, 0, 0, 0.7); }
        #gallery-prev { left: 15px; }
        #gallery-next { right: 15px; }
        .gallery-main-view img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease; }
        .gallery-main-view img:hover { transform: scale(1.05); }
        .gallery-thumbnails { display: flex; overflow-x: auto; overflow-y: hidden; padding-bottom: 10px; gap: 10px; }
        .gallery-thumbnails img { width: 100px; height: 100px; object-fit: cover; cursor: pointer; border: 2px solid transparent; border-radius: 4px; transition: border-color 0.2s ease, opacity 0.2s ease; opacity: 0.7; }
        .gallery-thumbnails img:hover { border-color: #FF9933; opacity: 1; }
        .gallery-thumbnails img.active { border-color: #044266; opacity: 1; }

        /* --- ESTILOS PARA EL STICKY HEADER MÓVIL (ANIMADO) --- */
        #producto-nombre-movil {
            background: white;
            width: 100%;
            padding: 15px;
            z-index: 1020;
            /* Transición suave para todo */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: top center;
            /* Estado inicial relativo */
            position: relative;
            box-shadow: none;
        }

        /* Contenedor de la info extra que desaparecerá */
        .extra-info {
            transition: opacity 0.2s ease, max-height 0.3s ease;
            opacity: 1;
            max-height: 200px; /* Altura suficiente para el contenido */
            overflow: hidden;
        }

        /* --- ESTADO "PEGADO" (STUCK) --- */
        #producto-nombre-movil.is-stuck {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Sombra suave */
            border-bottom: 1px solid #f0f0f0;
            background: rgba(255, 255, 255, 0.98); /* Casi opaco */
            backdrop-filter: blur(5px); /* Efecto moderno */
            animation: slideDown 0.3s ease forwards; /* Animación de entrada */
        }

        /* Animación de entrada desde arriba */
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* Transformación del Título */
        #producto-nombre-movil h1 {
            transition: font-size 0.3s ease;
        }

        #producto-nombre-movil.is-stuck h1 {
            font-size: 16px !important; /* Reducción de tamaño */
            margin: 0 !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #044266;
            text-align: center !important; /* Centrado queda más "app" */
        }

        /* Ocultar suavemente la info extra */
        #producto-nombre-movil.is-stuck .extra-info {
            opacity: 0;
            max-height: 0;
            margin: 0;
        }

        /* Placeholder para evitar el salto de contenido */
        #sticky-placeholder {
            display: none;
            /* La altura se ajustará con JS o CSS según el contenido */
            height: 140px;
        }
        #producto-nombre-movil.is-stuck + #sticky-placeholder {
            display: block;
        }

        /* Ajuste del centinela: Lo bajamos para que salte más tarde */
        #sticky-sentinel {
            position: absolute;
            top: 80px; /* <-- AJUSTE CLAVE: Salta cuando has bajado 80px */
            height: 1px;
            width: 100%;
            visibility: hidden;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/jquery/fileUpload/js/vendor/jquery.ui.widget.min.js') }}"></script>
    <script src="{{ asset('js/jquery/fileUpload/js/jquery.iframe-transport.min.js') }}"></script>
    <script src="{{ asset('js/jquery/fileUpload/js/jquery.fileupload.min.js') }}"></script>
    {% include 'web/product/partials/_product_page_javascript.html.twig' %}

    {# --- SCRIPT OBSERVER --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const target = document.getElementById('producto-nombre-movil');
            const sentinel = document.getElementById('sticky-sentinel');
            const placeholder = document.getElementById('sticky-placeholder');

            // Calculamos la altura real del bloque para el placeholder
            if(target && placeholder) {
                const height = target.offsetHeight;
                placeholder.style.height = height + 'px';
            }

            if(target && sentinel) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        // Solo activamos si estamos bajando y el centinela sale por arriba
                        if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
                            target.classList.add('is-stuck');
                        } else {
                            target.classList.remove('is-stuck');
                        }
                    });
                }, { threshold: 0 }); // threshold 0 dispara en cuanto toca el borde

                observer.observe(sentinel);
            }
        });
    </script>
{% endblock %}

{% block meta %}
    {# ... Metadatos sin cambios ... #}
    <meta property="og:site_name" content="www.tuskamisetas.com"/>
    <meta property="og:type" content="product"/>
    <meta property="og:title" content="{{ modelo.nombre|title }}"/>
    <meta property="og:description" content="{{ modelo.descripcion|striptags|slice(0, 200) }}"/>
    <meta property="og:url" content="{{ url('app_product_detail', {'_locale': app.request.locale, 'slug': modelo.nombreUrl}) }}"/>
    {% if modelo.imagen %}
        <meta property="og:image" content="{{ sonata_path(modelo.imagen, 'big') }}"/>
    {% elseif modelo.urlImage %}
        <meta property="og:image" content="{{ modelo.urlImage }}"/>
    {% endif %}
    <meta property="product:brand" content="{{ modelo.fabricante.nombre }}">
    <meta property="product:availability" content="instock"/>
    <meta property="product:condition" content="new">
    <meta property="product:price:amount" content="{{ modelo.getPrecioUnidad(app.user) | number_format(2, '.', ',') }}"/>
    <meta property="product:price:currency" content="EUR"/>
    <meta property="product:retailer_item_id" content="{{ modelo.referencia }}">
{% endblock %}

{% block migas %}
    {% if modelo.category is not empty and modelo.category|first %}
        {% include 'web/partials/_breadcrumbs.html.twig' with {'context': modelo.category|first} %}
    {% endif %}
{% endblock %}

{% block modals %}
    {# ... Modales sin cambios ... #}
    <div id="presupuestoRapidoModal" class="modal fade" role="dialog"></div>
    <div id="360Modal" class="modal fade" role="dialog"></div>
    <div id="fotos-detalle-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Detalles del Producto</h4>
                </div>
                <div class="modal-body">
                    <div class="modal-gallery" id="galeria-producto-detalle">
                        <div class="gallery-main-view">
                            <button id="gallery-prev" class="gallery-nav">&#10094;</button>
                            <img id="gallery-main-image" src="" alt="Vista principal de la galería">
                            <button id="gallery-next" class="gallery-nav">&#10095;</button>
                        </div>
                        <div class="gallery-thumbnails"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="medidas-talla-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{% trans %}MEDIDAS POR TALLA{% endtrans %}</h4>
                </div>
                <div class="modal-body">
                    {% if modelo.getDrawing is defined and modelo.getDrawing != null %}
                        <div>
                            <img class="img-responsive" src="{{ sonata_path(modelo.getDrawing, 'wide') }}" alt="ficha técnica del producto"/>
                        </div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table-responsive" style="text-align: center; font-size: 12px; width: 100%">
                                <tr>
                                    <td style="border: 1px solid darkgray; background-color: lightgrey;"><b>{% trans %}Talla{% endtrans %}</b></td>
                                    <td style="border: 1px solid darkgray; background-color: lightgrey;"><b>{% trans %}Medidas{% endtrans %}</b></td>
                                </tr>
                                {% for talla in modelo.getTallasP %}
                                    <tr>
                                        <td style="border: 1px solid darkgray;"><b>{{ talla.talla }}</b></td>
                                        <td style="border: 1px solid darkgray;"><b>{{ talla.medidas }}</b></td>
                                    </tr>
                                {% endfor %}
                                <tr>
                                    <td style="border: 1px solid darkgray" colspan="2"><p style="font-size: 12px">Las medidas son aproximadas.</p></td>
                                </tr>
                            </table>
                            <div class="row" style="margin-top: 15px;">
                                <div class="col-xs-3" style="text-align: center"><img src="{{ asset('images/medir-camiseta.jpg') }}" style="max-width:130px;width: 100%; height: auto" alt="Patron para medir camisetas"/></div>
                                <div class="col-xs-3" style="text-align: center"><img src="{{ asset('images/medir-sudadera.jpg') }}" style="max-width:130px;width: 100%; height: auto" alt="Patron para medir sudaderas"/></div>
                                <div class="col-xs-3" style="text-align: center"><img src="{{ asset('images/medir-pantalon.jpg') }}" style="max-width:130px;width: 100%; height: auto" alt="Patron para medir pantalones"/></div>
                                <div class="col-xs-3" style="text-align: center"><img src="{{ asset('images/medir-bolsa.jpg') }}" style="max-width:130px;width: 100%; height: auto" alt="Patron para medir bolsas y regalos"/></div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div id="editor-talla-modal" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 80%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{% trans %}MEDIAS POR TALLA{% endtrans %}</h4>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block flotantes %}
    <div id="floatingPriceCircle" class="scrollResumen">
        <div class="circulo-contenido">
            <span id="circulo-unidades" style="font-size: 14px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.5); margin-bottom: 3px; padding-bottom: 2px;">0 uds</span>
            <span class="circulo-label" style="font-size: 9px;">Precio/ud</span>
            <span id="circulo-precio-valor" class="circulo-valor">{{ modelo.getPrecioUnidad(app.user) | number_format(2, ',', '.') }}€</span>
        </div>
    </div>
{% endblock %}

{% block baseBody %}
    <div itemscope itemtype="http://schema.org/Product" style="margin-bottom: 15px">
        <div class="container">
            <div class="row">

                {# --- BLOQUE NOMBRE MÓVIL CON CENTINELA --- #}
                <div style="position: relative;">
                    {# Centinela invisible: Lo bajamos 80px para que el efecto empiece más tarde #}
                    <div id="sticky-sentinel"></div>

                    <div id="producto-nombre-movil" class="col-lg-12 hidden-sm hidden-md hidden-lg">
                        <h1 style="font-size: 28px; margin: 0px;" itemprop="name">{{ modelo.nombre | upper }}</h1>

                        <div class="extra-info">
                            <p itemprop="name">
                                <a style="color: black; font-size: 18px" href="{{ path('app_catalog_resolver', {'_locale': app.request.locale, 'slug': modelo.fabricante.nombreUrl}) }}">
                                    {{ modelo.fabricante.nombre }}
                                </a>
                            </p>
                            <h2 style="font-size: 14px; margin: 0px;">{{ modelo.familia }}</h2>
                            <p><b>REF:</b> {{ modelo.referencia }}</p>
                        </div>
                    </div>

                    {# Placeholder oculto que ocupa el espacio cuando el original se pega #}
                    <div id="sticky-placeholder" class="hidden-sm hidden-md hidden-lg"></div>
                </div>
                {# ----------------------------------------- #}

                <div class="col-sm-6 col-md-7" style="position: -webkit-sticky; position: sticky; top: 0; background-color: white">
                    {% include 'web/product/partials/_gallery.html.twig' %}
                    <div class="col-lg-12">
                        {# Redes sociales (Sin cambios) #}
                        <div class="redesReceta hidden-xl hidden-lg hidden-md hidden-sm" style="text-align: center; margin-top: 12px">
                            <a href="whatsapp://send?text=Mira lo que acabo de encontrar en TusKamisetas%20{{ app.request.uri }}?utm_source=whatsapp" target="_blank"><img src="{{ asset('images/whatsapp-logo.svg') }}" style="max-width: 18px;" alt="whatsapp"/></a>
                            <a href="http://www.facebook.com/sharer.php?u={{ app.request.uri }}" target="blank"><img src="{{ asset('images/facebook.svg') }}" style="max-width: 20px;" alt="facebook"/></a>
                            <a href="https://twitter.com/intent/tweet?url={{ app.request.uri }}" target="blank"><img src="{{ asset('images/twitter.svg') }}" style="max-width: 20px;" alt="twitter"/></a>
                            <a href="https://plus.google.com/share?url={{ app.request.uri }}" target="blank"><img src="{{ asset('images/google+.svg') }}" style="max-width: 20px;" alt="google plus"/></a>
                            {% if modelo.imagen != null %}
                                <a href="http://www.pinterest.com/pin/create/button/?url={{ app.request.uri }}" target="_blank"><img src="{{ asset('images/pinterest.svg') }}" style="max-width: 20px;" alt="pinterest"/></a>
                            {% else %}
                                <a href="http://www.pinterest.com/pin/create/button/?url={{ app.request.uri }}&media={{ modelo.urlImage }}&description={{ modelo.familia }} {{ modelo.nombre }}" target="_blank"><img src="{{ asset('images/pinterest.svg') }}" style="max-width: 20px;" alt="pinterest"/></a>
                            {% endif %}
                            <a href="mailto:?subject=Mira lo que acabo de encontrar en TusKamisetas&body={{ app.request.uri }}"><img src="{{ asset('images/comentario.svg') }}" style="max-width: 20px;" alt="mail"/></a>
                        </div>
                        <div class="redesReceta hidden-xs" style="text-align: center; margin-top: 12px">
                            {# ... redes escritorio ... #}
                            <a href="http://www.facebook.com/sharer.php?u={{ app.request.uri }}" target="blank"><img src="{{ asset('images/facebook.svg') }}" style="max-width: 20px;" alt="facebook"/></a>
                            <a href="https://twitter.com/intent/tweet?url={{ app.request.uri }}" target="blank"><img src="{{ asset('images/twitter.svg') }}" style="max-width: 20px;" alt="twitter"/></a>
                            <a href="https://plus.google.com/share?url={{ app.request.uri }}" target="blank"><img src="{{ asset('images/google+.svg') }}" style="max-width: 20px;" alt="google plus"/></a>
                            {% if modelo.imagen != null %}
                                <a href="http://www.pinterest.com/pin/create/button/?url={{ app.request.uri }}" target="_blank"><img src="{{ asset('images/pinterest.svg') }}" style="max-width: 20px;" alt="pinterest"/></a>
                            {% else %}
                                <a href="http://www.pinterest.com/pin/create/button/?url={{ app.request.uri }}&media={{ modelo.urlImage }}&description={{ modelo.familia }} {{ modelo.nombre }}" target="_blank"><img src="{{ asset('images/pinterest.svg') }}" style="max-width: 20px;" alt="pinterest"/></a>
                            {% endif %}
                            <a href="mailto:?subject=Mira lo que acabo de encontrar en TusKamisetas&body={{ app.request.uri }}"><img src="{{ asset('images/comentario.svg') }}" style="max-width: 20px;" alt="mail"/></a>
                        </div>

                        {% if is_granted('ROLE_ALLOWED_TO_SWITCH') %}
                            <div class="clear-fix"></div>
                            <div class="row" style="margin-top: 20px; margin-bottom: 20px;">
                                <div class="col-xs-6">
                                    <a href="{{ path('app_product_inventory', {'id': modelo.id, 'operacion': 1, '_locale': app.request.locale}) }}" class="btn btn-success btn-block" style="font-size: 16px; padding: 10px; color: white; font-weight: bold;"><i class="fa fa-plus-circle"></i> Entradas</a>
                                </div>
                                <div class="col-xs-6">
                                    <a href="{{ path('app_product_inventory', {'id': modelo.id, 'operacion': 2, '_locale': app.request.locale}) }}" class="btn btn-danger btn-block" style="font-size: 16px; padding: 10px; color: white; font-weight: bold;"><i class="fa fa-minus-circle"></i> Salidas</a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-6 col-md-5" style="position: -webkit-sticky; position: sticky; top: 0; background-color: white">
                    {% include 'web/product/partials/_details_panel.html.twig' %}
                    <div class="clearfix"></div>
                    <div style="background: #ececec; padding: 20px; margin-top: 15px;">
                        <p style="font-family: Roboto, sans-serif; font-size: 16px; font-weight: bold; text-align: center;">PIDELO HOY Y RECIBELO: </p>
                        <div style="text-align: left">
                            <p><span style="color: #044266">SIN PERSONALIZAR:</span><BR>
                                &nbsp;Envío normal: <b>{{ deliveryDates['fechaEntregaSinImprimir']|format_datetime(locale='es', pattern="d 'de' MMM") }} - {{ deliveryDates['fechaEntregaSinImprimir2']|format_datetime(locale='es', pattern="d 'de' MMM") }}</b>
                            </p>
                            <p><span style="color: #044266">PERSONALIZADO:</span><br>
                                &nbsp;Servicio normal: <b>{{ deliveryDates['fechaEntregaImpreso']|format_datetime(locale='es', pattern="d 'de' MMM") }} - {{ deliveryDates['fechaEntregaImpreso2']|format_datetime(locale='es', pattern="d 'de' MMM") }}</b><br>
                                &nbsp;Servicio express: <b>{{ deliveryDates['fechaEntregaExpress']|format_datetime(locale='es', pattern="d 'de' MMM") }}</b>
                            </p>
                            {% if empresa.vacacionesActivas %}
                                <p><b style="color: #044266">Estaremos cerrados por vacaciones desde el {{ empresa.fechaInicioVacaciones|format_datetime(locale='es', pattern="d 'de' MMM") }} hasta el {{ empresa.fechaFinVacaciones|format_datetime(locale='es', pattern="d 'de' MMM") }}</b></p>
                            {% endif %}
                        </div>
                    </div>

                    <div style="background: white; padding: 20px;">
                        <p style="font-family: Roboto, sans-serif; font-size: 16px; font-weight: bold; text-align: center;">MONTAJE PREVIO GRATUITO</p>
                        Te enviaremos un <b>montaje con tu diseño</b> para que valides que todo está donde y cómo te gusta
                    </div>
                    <div style="background: #f9f9f9; padding: 20px;">
                        <p style="font-family: Roboto, sans-serif; font-size: 16px; font-weight: bold; text-align: center;">¿TIENES ALGUNA DUDA?</p>
                        <button class="button calculaPresupuesto" data-toggle="modal" data-target="#presupuestoRapidoModal" style="background-color:#5bc0de; width: 100%; padding: 10px" title="Si deseas más información sobre este producto">
                            <b>{% trans %}CONTACTA{% endtrans %}</b>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12" id="div_personalizacion">
                {% include 'web/product/partials/_customization_panel.html.twig' %}
            </div>
        </div>
    </div>

    {% if modelo.modelosRelacionados|length > 0 %}
        <div class="recommended_items mt-5"><h2 class="title text-center">{% trans %}MODELOS RELACIONADOS{% endtrans %}</h2>
            <div class="row">
                {% for producto in modelo.modelosRelacionados %}
                    {% if producto.activo == true %}
                        <div>
                            {% include 'web/catalog/_productoElementoGrid.html.twig' with {'producto': producto} %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {% if vistos is defined and vistos|length > 0 %}
        <div class="recommended_items mt-5">
            <h2 class="title text-center">{% trans %}ÚLTIMOS PRODUCTOS VISTOS{% endtrans %}</h2>
            <div class="row">
                {% for producto in vistos %}
                    {% if producto.id != modelo.id %}
                        {% include 'web/partials/_ultimos_vistos_grid.html.twig' with {'producto': producto} %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endblock %}