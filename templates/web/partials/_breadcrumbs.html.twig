{# templates/web/partials/_breadcrumbs.html.twig #}

<div class="breadcrumbs">
    <ol itemscope itemtype="http://schema.org/BreadcrumbList" class="breadcrumb">

        {# --- 1. INICIALIZAMOS EL CONTADOR --- #}
        {% set currentPosition = 1 %}

        {# --- 2. HOME (Siempre Posición 1) --- #}
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a itemprop="item" href="{{ path('app_home', {'_locale': app.request.locale}) }}">
                <span itemprop="name">{% trans %}Principal{% endtrans %}</span>
            </a>
            <meta itemprop="position" content="{{ currentPosition }}"/>
        </li>

        {% set currentPosition = currentPosition + 1 %}


        {# --- 3. LOGICA DE FABRICANTE (Posición 2 si existe) --- #}
        {% set fabricante_a_mostrar = null %}
        {% if breadcrumb_fabricante is defined and breadcrumb_fabricante %}
            {% set fabricante_a_mostrar = breadcrumb_fabricante %}
        {% elseif context is defined and attribute(context, 'getMarca') is defined and context.getMarca %}
            {% set fabricante_a_mostrar = context.getMarca %}
        {% endif %}

        {% if fabricante_a_mostrar %}
            <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
                <a itemprop="item" href="{{ path('app_catalog_resolver', {'_locale': app.request.locale, 'slug': fabricante_a_mostrar.nombreUrl}) }}">
                    <span itemprop="name">{{ fabricante_a_mostrar.nombre }}</span>
                </a>
                <meta itemprop="position" content="{{ currentPosition }}"/>
            </li>
            {% set currentPosition = currentPosition + 1 %}
        {% endif %}


        {# --- 4. LOGICA DE ANCESTROS (Categorías Padre) --- #}
        {# En lugar de macro recursiva, recolectamos los padres en un array y los invertimos #}
        {% if context is defined and context %}

            {% set ancestors = [] %}
            {% set parent = attribute(context, 'parent') is defined ? context.parent : null %}

            {# Bucle de seguridad (máx 10 niveles) para subir por el árbol #}
            {% for i in 0..10 %}
                {% if parent and parent.name != 'Home' %}
                    {% set ancestors = ancestors|merge([parent]) %}
                    {% set parent = parent.parent|default(null) %}
                {% endif %}
            {% endfor %}

            {# Recorremos los ancestros DESDE EL MÁS ANTIGUO (reverse) #}
            {% for ancestor in ancestors|reverse %}
                <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
                    <a itemprop="item" href="{{ path('app_catalog_resolver', {'_locale': app.request.locale, 'slug': ancestor.slug}) }}">
                        <span itemprop="name">{{ ancestor.name }}</span>
                    </a>
                    <meta itemprop="position" content="{{ currentPosition }}"/>
                </li>
                {% set currentPosition = currentPosition + 1 %}
            {% endfor %}


            {# --- 5. ELEMENTO ACTUAL (El último) --- #}
            <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" class="active">
                {# SEO: Link invisible apuntando a la URL actual #}
                <link itemprop="item" href="{{ app.request.uri }}" />

                <span itemprop="name">{{ context.nombre|default(context) }}</span>

                {# SEO: La posición es exactamente la siguiente en la secuencia #}
                <meta itemprop="position" content="{{ currentPosition }}"/>
            </li>
        {% endif %}
    </ol>
</div>