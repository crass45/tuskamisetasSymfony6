{# templates/web/catalog/_productoElementoGrid.html.twig #}

{% if producto.nombreUrl is defined %}
    {# 1. Movemos la columna (col-xs...) para que sea el contenedor principal. #}
    <div class="col-xs-6 col-sm-6 col-md-4 col-lg-3" style="padding-right: 2px; padding-left: 2px;">

        {# Wrapper relativo para posicionar elementos absolutos (engranaje, badge) #}
        <div class="product-image-wrapper" style="position: relative;">

            {# --- ENGRANAJE ADMIN --- #}
            {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ 'https://tuskamisetas.com/admin/app/modelo/' ~ producto.id ~ '/edit' }}"
                   target="_blank"
                   style="position: absolute; bottom: 10px; left: 10px; z-index: 50; color: lightblue; font-size: 18px;">
                    <i class="fa fa-cog"></i>
                </a>
            {% endif %}

            {# --- ENLACE PRINCIPAL --- #}
            <a class="enlaceproducto"
               data-referencia="{{ producto.referencia }}"
               data-nombre="{{ producto.nombre }}"
               data-brand="{{ producto.fabricante }}"
               href="{{ path('app_product_detail', {'_locale': app.request.locale, 'slug': producto.nombreUrl}) }}"
               style="display: block; color: white; text-decoration: none;">

                <div class="single-products">
                    <div class="productinfo text-center" style="position: relative; min-height: 200px;">
                        {# Lógica LCP: Las 2 primeras imágenes cargan inmediato, el resto lazy #}
                        {% set is_lcp = (loop_index is defined and loop_index <= 2) %}
                        {% set imgSrc = (producto.imagen != null) ? sonata_path(producto.imagen, 'grid') : producto.urlImage %}

                        {# IMAGEN DEL PRODUCTO OPTIMIZADA #}
                        <img src="{{ imgSrc }}"
                             id="{{ producto.id }}"
                             alt="{{ producto.familia }} {{ producto.fabricante }} {{ producto.nombre }}"

                                {# OPTIMIZACIÓN DE RENDIMIENTO #}
                             loading="{{ is_lcp ? 'eager' : 'lazy' }}"
                             decoding="async"
                                {% if is_lcp %}fetchpriority="high"{% endif %}

                                {# DATOS PARA JAVASCRIPT (Hover de colores) #}
                             data-imagen="{{ imgSrc }}"

                                {# ESTABILIDAD VISUAL (Evita saltos de layout) #}
                             width="250" height="250"
                             style="width: 100%; height: auto; aspect-ratio: 1/1; object-fit: contain;"
                        />

                        {# BADGE NOVEDAD #}
                        {% if producto.isNovelty %}
                            <img src="{{ asset('template/images/new.png') }}"
                                 alt="novedad"
                                 loading="lazy"
                                 decoding="async"
                                 width="40" height="40"
                                 style="width: 40px; height: auto; position: absolute; right: 0; top: 0; border: none; z-index: 10;"/>
                        {% endif %}
                    </div>
                </div>

                <div class="productoGridDescripcion" style="color: white">
                    {% if producto is defined and producto is not null %}
                        <p style="height: 42px; margin-top: 15px; margin-right: 10px; overflow: hidden; line-height: 1.2;">
                            {{ producto.nombre | upper }}
                        </p>

                        {# PRECIOS #}
                        {% if producto.hasColorNino() or producto.hasBlancoNino() %}
                            <p>Infantil Desde <b>{{ producto.getPrecioCantidadBlancasNino(10000, app.user) | number_format(2, ',', '.') }} €</b></p>
                            {% if producto.getPrecioCantidadBlancas(10000, app.user) > 0 or producto.getPrecioCantidadColor(1000, app.user) > 0 %}
                                <p>Adultos Desde <b>{{ producto.getPrecioCantidadBlancas(10000,app.user) | number_format(2, ',', '.') }} €</b></p>
                            {% else %}
                                <p>&nbsp;</p>
                            {% endif %}
                        {% else %}
                            <p>Desde <b>{{ producto.getPrecioUnidad( app.user ) | number_format(2, ',', '.') }} €</b></p>
                            <p>&nbsp;</p>
                        {% endif %}

                        {# COLORES DISPONIBLES #}
                        <div class="grid-producto-colores" style="text-align: center">
                            {% for color in producto.getColoresProductos() %}
                                <div {% if (color.color is not null) %}style="background-color: {{ color.color.codigoRGB }};"{% endif %}
                                     class="cuadro-color cuadro-color-grid"
                                     data-imagen="{{ (color.imagen != null) ? sonata_path(color.imagen, 'grid') : color.urlImage }}"
                                     data-modelo="{{ producto.id }}">
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </a>
        </div>
    </div>
{% endif %}