{% extends "web/indexTemplate.html.twig" %}


{% block metas %}
    {{ parent() }} {# Mantenemos las metas del padre #}

    {# --- LÓGICA DE PAGINACIÓN SEO (REL=PREV/NEXT) --- #}

    {# 1. Calculamos el total de páginas si no viene del controlador #}
    {# Asumimos un límite de 20 items por página, cámbialo por tu valor real #}
    {% set limitPorPagina = 20 %}
    {% set totalPaginasCalc = (cantidadArticulos / limitPorPagina)|round(0, 'ceil') %}
    {# Si ya tienes una variable 'totalPaginas' o 'modelos.pageCount' (KnpPaginator), úsala en vez de 'totalPaginasCalc' #}

    {# 2. Obtenemos ruta y parámetros actuales #}
    {% set currentRoute = app.request.attributes.get('_route') %}
    {% set currentRouteParams = app.request.attributes.get('_route_params') %}
    {% set currentQueryParams = app.request.query.all %}

    {# Fusionamos atributos de ruta (slug) y query string (filtros) #}
    {% set allParams = currentRouteParams|merge(currentQueryParams) %}

    {# 3. Generar REL="PREV" #}
    {% if paginaActual > 1 %}
        {% set prevParams = allParams|merge({'page': paginaActual - 1}) %}
        <link rel="prev" href="{{ path(currentRoute, prevParams) }}" />
    {% endif %}

    {# 4. Generar REL="NEXT" #}
    {% if paginaActual < totalPaginasCalc %}
        {% set nextParams = allParams|merge({'page': paginaActual + 1}) %}
        <link rel="next" href="{{ path(currentRoute, nextParams) }}" />
    {% endif %}

{% endblock %}

{% block title %}
    {% if context is defined and context is not null %}
        {# 1. Intentamos usar el título SEO específico #}
        {% if context.tituloSEO is defined and context.tituloSEO is not empty %}
            {{ context.tituloSEO }}
        {% else %}
            {# 2. Fallback: Usamos el nombre de la categoría/familia #}
            {{ context.nombre|default('Catálogo')|capitalize }}
        {% endif %}

        {# 3. Añadimos el número de página si no es la 1 (Buenas prácticas SEO) #}
        {% if paginaActual is defined and paginaActual > 1 %}
            - Página {{ paginaActual }}
        {% endif %}
    {% else %}
        Catálogazo
    {% endif %}
{% endblock %}

{# --- BLOQUE DE META DESCRIPTION (SEO) --- #}
{% block metaDescription %}
    {% if context is defined and context is not null %}
        {# 1. Intentamos usar la descripción SEO específica #}
        {% if context.descripcionSEO is defined and context.descripcionSEO is not empty %}
            {{ context.descripcionSEO }}
        {% elseif context.descripcion is defined and context.descripcion is not empty %}
            {# 2. Fallback: Usamos la descripción visual limpia de HTML y cortada #}
            {{ context.descripcion|striptags|trim|slice(0, 160) }}...
        {% endif %}

        {# 3. Añadimos paginación a la description también #}
        {% if paginaActual is defined and paginaActual > 1 %}
            (Página {{ paginaActual }})
        {% endif %}
    {% endif %}
{% endblock %}

{% block migas %}
    {# MIGRACIÓN: El bloque de migas de pan ahora es mucho más simple y se construye a partir del objeto 'context' #}
    {% include 'web/partials/_breadcrumbs.html.twig' %}
{% endblock %}

{% block cuerpo %}
<div class="features_items">
    {% include 'web/partials/_filtros_activos.html.twig' %}

    <h1 class="title text-center">{{ nombrePanel|default(context.nombre|default('Catálogo')) }}</h1>
    <p class="subtitle text-center">- {{ cantidadArticulos }} Artículos -</p>


    {% if paginaActual <= 1 %}
        {# 1. BLOQUE DE SUBCATEGORÍAS #}
        {% set categoriaObj = context %}
        {% if categoriaObj is defined and categoriaObj.children is defined and categoriaObj.children | length > 0 %}
{#            ESTA ES LA COMPROBACIÓN DE QUE NO HAYA FILTROS#}
            {% if not filtros.fabricante and filtros.atributos is empty and filtros.colores is empty %}
                {% for subcategoria in categoriaObj.children %}
                    {% if subcategoria.enabled %}
                        {# Lógica de optimización: Las 4 primeras cargan al instante #}
                        {% set is_lcp = (loop.index <= 4) %}
                        {% set img_path = subcategoria.imagen ? sonata_path(subcategoria.imagen, 'grid') : asset('images/dummy200.png') %}

                        <a href="{{ path('app_catalog_resolver', {'_locale': app.request.locale, 'slug': subcategoria.slug}) }}"
                           style="color: white">
                            <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3"
                                 style="padding-left: 2px; padding-right: 2px">
                                <div class="product-image-wrapper zoomHoverTKM" style="position: relative;">
                                    <div class="single-products" style="height: 250px">
                                        as
                                        <div class="productinfo text-center">

                                            <img src="{{ is_lcp ? img_path : asset('images/dummy200.png') }}"
                                                 {% if not is_lcp %}class="lazy" data-src="{{ img_path }}"{% endif %}
                                                 alt="Comprar {{ subcategoria.name }} baratas"
{#                                                 width="363" height="300"#}
                                                    {% if is_lcp %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
                                            />

                                        </div>
                                    </div>

                                    <div class="productoGridDescripcion">
                                        <br>
                                        <p style="text-align: center; color: white; font-size: 16px">{{ subcategoria.name | upper }}</p>
                                        <br>
                                    </div>
                                </div>
                            </div>
                        </a>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
        <div class="clearfix"></div>

        {# 2. BLOQUE DE TEXTO SUPERIOR #}
        {% if context.textoArriba is defined and context.textoArriba is not empty %}
            <div class="textosTkm" style="padding: 15px; font-size: 13px;">
                {{ context.textoArriba | raw }}
            </div>
        {% endif %}
    {% endif %}

    {# MIGRACIÓN: Incluimos la nueva parrilla de productos, pasándole los modelos del paginador #}
    {% include 'web/catalog/_producto_grid.html.twig' with {'modelos': modelos} %}
    {#    </div> #}
    <div class="clearfix"></div>
    {% if context.textoAbajo is defined %}
        {% if paginaActual <= 1 %}
            <div class="textosTkm" style="padding: 15px; font-size: 13px;">
                {{ context.textoAbajo |raw }}
            </div>
        {% endif %}
    {% endif %}


    {# MIGRACIÓN: El JavaScript ahora necesita generar las URLs de los filtros #}
    <script>
        function eliminaFabricante(fabricanteId) {
            const params = new URLSearchParams(window.location.search);
            params.delete('fabricante'); // Suponiendo que el filtro se llama 'fabricante'
            window.location.search = params.toString();
        }

        // ... (lógica similar para eliminaColor y eliminaFiltro)
    </script>
    {% endblock %}
