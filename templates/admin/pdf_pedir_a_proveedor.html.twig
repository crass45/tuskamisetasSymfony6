<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Presupuesto por Proveedor</title>

    <style>
        .clearfix:after {
            content: "";
            display: table;
            clear: both;
        }

        a {
            color: #5D6975;
            text-decoration: underline;
        }

        body {
            position: relative;
            width: 21cm;
            height: 29.7cm;
            margin: 0 auto;
            color: #001028;
            background: #FFFFFF;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        header {
            padding: 10px 0;
            margin-bottom: 30px;
        }

        #logo {
            text-align: center;
            margin-bottom: 10px;
        }

        #logo img {
            width: 90px;
        }

        h1 {
            border-top: 1px solid #5D6975;
            border-bottom: 1px solid #5D6975;
            color: #5D6975;
            font-size: 2.4em;
            line-height: 1.4em;
            font-weight: normal;
            text-align: center;
            margin: 0 0 20px 0;
            background: url(dimension.png);
        }

        /* ESTILOS DE TABLA */
        table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            margin-bottom: 10px;
        }

        table tr:nth-child(2n-1) td {
            background: #F5F5F5;
        }

        table th,
        table td {
            text-align: center;
        }

        table th {
            padding: 5px 20px;
            color: #5D6975;
            border-bottom: 1px solid #C1CED9;
            white-space: nowrap;
            font-weight: normal;
        }

        table .service,
        table .desc {
            text-align: left;
        }

        table td {
            text-align: right;
        }

        table td.service,
        table td.desc {
            vertical-align: top;
            padding: 10px 5px;
        }

        table td.qty {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 5px;
        }

        #notices .notice {
            color: #5D6975;
            font-size: 1.2em;
        }

        /* NUEVOS ESTILOS PARA AGRUPACIÓN */
        .proveedor-header {
            background-color: #5D6975;
            color: #fff;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 20px;
            text-transform: uppercase;
        }

        .separador-proveedor {
            margin-top: 30px;
            margin-bottom: 30px;
            text-align: center;
            clear: both;
        }

        .linea-corte {
            border-top: 2px dashed #aaa;
            position: relative;
            height: 20px;
        }

        .texto-corte {
            background-color: #fff;
            padding: 0 15px;
            color: #aaa;
            position: relative;
            top: -12px;
            font-size: 10px;
            text-transform: uppercase;
        }
    </style>

</head>
<body>
<header class="clearfix">
    <div id="logo" style="text-align: left">
        <img src="http://www.tuskamisetas.com/uploads/media/default/0001/01/pollo_admin.jpeg"
             alt="{{ empresa.nombre }}">
        <div style="display: inline-block; margin-left: 15px">
            <div><h2 style="margin-bottom: 0;">{{ empresa.nombre }}</h2></div>
            <div>{{ empresa.direccion.dir }}
                <br>{{ empresa.direccion.cp }} {{ empresa.direccion.poblacion }} {{ empresa.direccion.provincia }}
            </div>
            <div>{{ empresa.telefonoOtro }}</div>
            <div><a href="mailto:{{ empresa.email }}">{{ empresa.email }}</a></div>
            <div>{{ empresa.cif }}</div>
        </div>

    </div>
</header>
<main>

    {# 1. LÓGICA: Extraemos la lista de proveedores únicos que hay en el carrito #}
    {% set proveedores_unicos = [] %}
    {% for presupuesto in carrito.getItems() %}
        {% for producto in presupuesto.getProductos() %}
            {% if producto.cantidad > 0 %}
                {# Obtenemos nombre del proveedor. Si es nulo, ponemos 'Varios' #}
                {% set provName = producto.producto.modelo.proveedor.nombre ?? 'OTROS' %}

                {% if provName not in proveedores_unicos %}
                    {% set proveedores_unicos = proveedores_unicos|merge([provName]) %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endfor %}

    {# 2. LÓGICA: Creamos un bloque completo por cada proveedor encontrado #}
    {% for proveedor in proveedores_unicos %}

        {# Evitamos que se rompa la tabla a mitad de página si es posible #}
        <div style="page-break-inside: avoid;">

            <div class="proveedor-header">
                PROVEEDOR: {{ proveedor }}
            </div>

            <table width="100%">
                <thead>
                <tr style="background-color: #C1CED9">
                    <th class="service" width="20%">CÓDIGO</th>
                    <th class="desc" width="60%">DESCRIPCION</th>
                    <th width="20%">CANTIDAD</th>
                </tr>
                </thead>
                <tbody>

                {# 3. LÓGICA: Filtramos productos que coincidan con el proveedor actual #}
                {% for presupuesto in carrito.getItems() %}
                    {% for producto in presupuesto.getProductos() %}
                        {% if producto.cantidad > 0 %}
                            {% set currentProv = producto.producto.modelo.proveedor.nombre ?? 'OTROS' %}

                            {% if currentProv == proveedor %}
                                <tr>
                                    <td class="service">
                                        {{ producto.producto.modelo.referencia }}<br>
                                        <small>({{ producto.producto.referencia }})</small>
                                    </td>
                                    <td class="desc">
                                        <b>{{ producto.producto.modelo.nombre }}</b>
                                        <br>
                                        {# Intento seguro de mostrar color y talla #}
                                        Talla: {{ producto.producto.talla }} |
                                        Color: {{ producto.producto.color.nombre is defined ? producto.producto.color.nombre : producto.producto.color }}

                                        {% if presupuesto.getTrabajos()|length > 0 %}
                                            <br>
                                            <span style="font-size: 10px; color: #666;">
                                            Personalización:
                                            {% for trabajo in presupuesto.getTrabajos() %}
                                                {{ trabajo }}
                                            {% endfor %}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="qty">{{ producto.cantidad }}</td>
                                </tr>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>


{#        #}{# Salto de página para que cada proveedor salga en hoja nueva (Opcional) #}
{#        <div style="page-break-after: always;"></div>#}

    {% endfor %}

    {# Observaciones Globales al final #}
    {% if carrito.observaciones is defined and carrito.observaciones != "" %}
        <div id="notices" style="border: 2px solid #5D6975; padding: 15px; margin-top: 20px; page-break-inside: avoid;">
            <div style="font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 10px;">PEDIDOS A REVISAR / OBSERVACIONES:</div>
            <div class="notice" style="font-size: 12px;">{{ carrito.observaciones | raw }}</div>
        </div>
    {% endif %}

</main>
</body>
</html>