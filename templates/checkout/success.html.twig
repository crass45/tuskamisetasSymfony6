{% extends "base.html.twig" %}

{% block title %}¡Presupuesto Recibido!{% endblock %}

{% block baseBody %}
    <div class="container" style="padding: 40px 15px; text-align: center;">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <i class="fa fa-check-circle" style="font-size: 80px; color: #5cb85c;"></i>
                <h1 style="margin-top: 20px;">¡Gracias por tu solicitud!</h1>
                <p class="lead">
                    Hemos recibido tu solicitud de presupuesto con el número <strong>{{ pedido }}</strong>.
                </p>
                <p>
                    Nuestro equipo comercial la revisará a la mayor brevedad posible. Recibirás un correo electrónico con los detalles y los siguientes pasos para confirmar y pagar tu pedido.
                </p>
                <hr>
                <p>
                    Si tienes cualquier duda, no dudes en <a href="{{ path('app_contact', {'_locale': app.request.locale}) }}">contactar con nosotros</a>.
                </p>
                <a href="{{ path('app_home', {'_locale': app.request.locale}) }}" class="btn btn-primary" style="margin-top: 20px;">
                    Volver a la página principal
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{# --- INICIO DE LA MODIFICACIÓN: CÓDIGO DE SEGUIMIENTO --- #}
{% block javascripts %}
    {{ parent() }}
    <script>
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
            'event': 'generate_lead',
            'ecommerce': {
                'transaction_id': '{{ pedido.nombre | default('') }}',      {# ID de la transacción (tu número de pedido) #}
                'value': {{ pedido.total | default(0) }},             {# Valor total del presupuesto #}
                'currency': 'EUR',                                  {# Moneda #}
                'items': [
                    {# Iteramos sobre las líneas del pedido para añadirlas al dataLayer #}
                    {% for linea in pedido.lineas %}
                    {
                        'item_id': '{{ linea.producto.modelo.referencia | default(linea.producto.referencia | default('SKU_DEFAULT')) }}',
                        'item_name': '{{ linea.producto.modelo.nombre | default('Producto') }}',
                        'item_brand': '{{ linea.producto.modelo.fabricante.nombre | default('Sin Marca') }}',
                        'item_variant': '{{ linea.producto.referencia | default('') }}',
                        'price': {{ linea.precio | default(0) }},
                        'quantity': {{ linea.cantidad | default(0) }}
                    }{% if not loop.last %},{% endif %} {# Añade una coma entre items, pero no al final #}
                    {% endfor %}
                ],

                {# --- DATOS DE CONVERSIONES MEJORADAS (ENHANCED CONVERSIONS) --- #}
                {# IMPORTANTE: Asegúrate de configurar GTM para que aplique hashing SHA-256 a estos campos #}
                'user_data': {
                    'email': '{{ pedido.contacto.usuario.email | default('') }}',
                    'phone_number': '{{ pedido.contacto.direccionFacturacion.telefonoMovil | default('') }}',
                    'address': {
                        'first_name': '{{ pedido.contacto.nombre | default('') }}',
                        'last_name': '{{ pedido.contacto.apellidos | default('') }}',
                        'street': '{{ pedido.contacto.direccionFacturacion.dir | default('') }}',
                        'city': '{{ pedido.contacto.direccionFacturacion.poblacion | default('') }}',
                        'region': '{{ pedido.contacto.direccionFacturacion.provinciaBD | default('') }}',
                        'postal_code': '{{ pedido.contacto.direccionFacturacion.cp | default('') }}',
                        'country': '{{ pedido.contacto.direccionFacturacion.paisBD | default('ES') }}'
                    }
                }
            }
        });
    </script>
{% endblock %}
{# --- FIN DE LA MODIFICACIÓN --- #}