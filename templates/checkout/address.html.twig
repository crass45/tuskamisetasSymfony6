{% extends "carrito/layout.html.twig" %}

{% block title %}Datos de Envío y Facturación{% endblock %}

{% block cuerpoProceso %}
    <div class="row" style="background-color: white; padding: 20px;">
        <form action="{{ path('app_checkout_process', {'_locale': app.request.locale}) }}" method="post" id="checkoutForm">
            <input type="hidden" id="tipoEnvio" name="tipoEnvio" value="1">

            <div class="col-lg-6" style="text-align: left;">
                <div class="border_gris login-form" style="padding: 20px">
                    <h3 style="font-weight: bold">DATOS DE FACTURACIÓN</h3>
                    <div id="billingForm" data-province-id="{{ formContacto.vars.value.direccionFacturacion.provinciaBD.id|default('') }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form_label(formContacto.nombre) }}
                                    {{ form_widget(formContacto.nombre, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(formContacto.nombre) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(formContacto.apellidos) }}
                                    {{ form_widget(formContacto.apellidos, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(formContacto.apellidos) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(formContacto.cif) }}
                                    {{ form_widget(formContacto.cif, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(formContacto.cif) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(formContacto.telefonoMovil) }}
                                    {{ form_widget(formContacto.telefonoMovil, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(formContacto.telefonoMovil) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(formContacto.telefonoOtro) }}
                                    {{ form_widget(formContacto.telefonoOtro, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(formContacto.telefonoOtro) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                {% set billing_address_form = formContacto.direccionFacturacion %}
                                <div class="form-group">
                                    {{ form_label(billing_address_form.dir) }}
                                    {{ form_widget(billing_address_form.dir, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(billing_address_form.dir) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(billing_address_form.cp) }}
                                    {{ form_widget(billing_address_form.cp, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(billing_address_form.cp) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(billing_address_form.poblacion) }}
                                    {{ form_widget(billing_address_form.poblacion, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(billing_address_form.poblacion) }}
                                </div>
                                <div class="form-group">
                                    {{ form_label(billing_address_form.paisBD) }}
                                    {{ form_widget(billing_address_form.paisBD) }}
                                    {{ form_errors(billing_address_form.paisBD) }}
                                </div>
                                <div class="form-group province-select-container">
                                    {{ form_label(billing_address_form.provinciaBD) }}
                                    {{ form_widget(billing_address_form.provinciaBD, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(billing_address_form.provinciaBD) }}
                                </div>
                                <div class="form-group province-text-input-container" style="display: none;">
                                    {{ form_label(billing_address_form.provincia) }}
                                    {{ form_widget(billing_address_form.provincia, {'attr': {'class': 'form-control form-control-lg'}}) }}
                                    {{ form_errors(billing_address_form.provincia) }}
                                </div>
                            </div>
                        </div>
                        {{ form_rest(formContacto) }}
                    </div>
                </div>
            </div>

            <div class="col-lg-6" style="text-align: left;">
                <div class="border_gris" style="padding: 20px">
                    <h3 style="font-weight: bold">{% trans %}DIRECCIÓN DE ENTREGA{% endtrans %}</h3>
                    <ul class="nav nav-tabs" id="entregaTab" role="tablist">
                        <li class="nav-item active"><a class="nav-link" data-toggle="tab" data-tipoenvio="1" href="#mismadireccion">{% trans %}Misma que facturación{% endtrans %}</a></li>
                        <li class="nav-item"><a class="nav-link" data-toggle="tab" data-tipoenvio="2" href="#nuevadireccion">{% trans %}Otra dirección{% endtrans %}</a></li>
                        <li class="nav-item"><a class="nav-link" data-toggle="tab" data-tipoenvio="3" href="#recogertienda">{% trans %}Recoger en tienda{% endtrans %}</a></li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade in active" id="mismadireccion"><br><h4 style="font-weight: bold">El pedido se enviará a la dirección de facturación</h4></div>
                        <div class="tab-pane fade" id="nuevadireccion">
                            {% if contacto.direccionesEnvio is not empty %}
                                <h4 style="font-weight: bold; margin-top: 15px;">Mis Direcciones</h4>
                                <select class="form-control" name="misdirecciones" id="misdirecciones">
                                    <option value="-1">Crear una nueva dirección</option>
                                    {% for direccion in contacto.direccionesEnvio %}
                                        <option value="{{ direccion.id }}"{% if direccion.predeterminada %}selected{% endif %}>{{ direccion }}</option>
                                    {% endfor %}
                                </select>
                            {% endif %}

                            <div id="newAddressFormContainer" style="margin-top: 15px; display: none;">
                                {% include 'checkout/partials/_address_form.html.twig' with {'form': formEnvio} %}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="recogertienda"><br><h4 style="font-weight: bold">{% trans %}RECOGER EN TUSKAMISETAS{% endtrans %}</h4><p>Cuando su pedido esté listo le enviaremos un email para que pueda recogerlo en nuestras instalaciones.</p></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-12">
                <div style="margin:15px; border-top: 1px dashed #999;"></div>
                <div class="col-lg-12 " style="text-align: right">
                    <div style="margin-bottom: 10px;">
                        <input id="privacityTKM" type="checkbox" required>
                        <label for="privacityTKM">Acepto los <a href="{{ path('app_terms_of_use', {'_locale': app.request.locale}) }}" target="_blank">Términos de uso</a> y la <a href="{{ path('app_privacy_policy', {'_locale': app.request.locale}) }}" target="_blank">Política de privacidad</a></label>
                    </div>
                </div>
                <div class="col-xs-6" style="text-align:left; margin-top:20px; margin-bottom: 20px;">
                    <a class="btn btn-default check_out" href="{{ path('app_cart_show', {'_locale': app.request.locale}) }}">Volver al Carrito</a>
                </div>
                <div class="col-xs-6" style="text-align:right; margin-top:20px; margin-bottom: 20px">
                    <button type="submit" id="confirmarPedidoBtn" class="btn btn-default check_out" style="background-color: #ff9000;">
                        {% trans %}Continuar con el Pedido{% endtrans %}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            // --- LÓGICA PARA PESTAÑAS Y DESPLEGABLE DE DIRECCIONES ---
            $('#entregaTab a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                const tipoEnvio = $(e.target).data('tipoenvio');
                $('#tipoEnvio').val(tipoEnvio);
            });

            function toggleNewAddressForm() {
                if ($('#misdirecciones').val() == '-1') {
                    $('#newAddressFormContainer').slideDown();
                } else {
                    $('#newAddressFormContainer').slideUp();
                }
            }
            $('#misdirecciones').on('change', toggleNewAddressForm);

            // Se ejecuta al cargar la página para establecer el estado inicial
            if($("#misdirecciones").length) {
                toggleNewAddressForm();
                if ($("#misdirecciones").val() != -1) {
                    $('#nuevadireccion-tab').tab('show');
                } else {
                    $('#mismadireccion-tab').trigger('click');
                }
            } else {
                $('#newAddressFormContainer').show(); // Si no hay direcciones guardadas, se muestra el form por defecto
                $('#mismadireccion-tab').trigger('click');
            }

            // ===================================================================
            // INICIO DE LA CORRECCIÓN DEL JAVASCRIPT
            // ===================================================================
            function handleCountryChange(countrySelectElement) {
                const $formContainer = $(countrySelectElement).closest('#billingForm, #newAddressFormContainer');
                if ($formContainer.length === 0) return;

                const $provinceSelectContainer = $formContainer.find('.province-select-container');
                const $provinceTextContainer = $formContainer.find('.province-text-input-container');
                const $provinceSelect = $provinceSelectContainer.find('select');
                const $provinceInput = $provinceTextContainer.find('input');
                const paisID = $(countrySelectElement).val();

                if (!paisID) {
                    $provinceSelectContainer.hide();
                    $provinceSelect.prop('disabled', true); // Se desactiva el select
                    $provinceTextContainer.show();
                    $provinceInput.prop('disabled', false); // Se activa el input
                    return;
                }

                let url = "{{ path('api_get_country_provinces', {id: 'PAIS_ID'}) }}".replace('PAIS_ID', paisID);

                $.ajax({
                    url: url,
                    type: "GET",
                    dataType: "JSON",
                    success: function (provincias) {
                        const savedProvinceId = $formContainer.data('province-id');

                        if (provincias.length > 0) {
                            $provinceSelect.html('<option value="">Selecciona una provincia...</option>');
                            $.each(provincias, function (key, provincia) {
                                $provinceSelect.append(`<option value="${provincia.id}">${provincia.name}</option>`);
                            });
                            if (savedProvinceId) {
                                $provinceSelect.val(savedProvinceId);
                            }
                            $provinceSelectContainer.show();
                            $provinceSelect.prop('disabled', false); // Se activa el select
                            $provinceTextContainer.hide();
                            $provinceInput.prop('disabled', true); // Se desactiva el input
                        } else {
                            $provinceSelectContainer.hide();
                            $provinceSelect.prop('disabled', true); // Se desactiva el select
                            $provinceTextContainer.show();
                            $provinceInput.prop('disabled', false); // Se activa el input
                        }
                    },
                    error: function(err) {
                        console.error("Error al cargar las provincias:", err);
                        $provinceSelectContainer.hide();
                        $provinceSelect.prop('disabled', true);
                        $provinceTextContainer.show();
                        $provinceInput.prop('disabled', false);
                    }
                });
            }

            $('body').on('change', '.country-selector', function() {
                handleCountryChange(this);
            });

            handleCountryChange($('#billingForm').find('.country-selector'));
            handleCountryChange($('#newAddressFormContainer').find('.country-selector'));
            // ===================================================================
            // FIN DE LA CORRECCIÓN
            // ===================================================================

            // Se usa delegación de eventos para que funcione con ambos formularios
            $('body').on('change', '.country-selector', function() {
                handleCountryChange(this);
            });

            // Se inicializa para el formulario de facturación al cargar la página
            handleCountryChange($('#billingForm').find('.country-selector'));
            handleCountryChange($('#newAddressFormContainer').find('.country-selector'));

            // --- LÓGICA PARA SUBMIT ---
            $('#confirmarPedidoBtn').on('click', function(e) {
                if (!$('#privacityTKM').is(":checked")) {
                    alert("Debes aceptar los términos y la política de privacidad.");
                    e.preventDefault();
                }
                // ... (Tu lógica de GTag aquí)
            });
        });
    </script>
{% endblock %}

