{# templates/carrito/partials/_cart_summary.html.twig #}
{# Este parcial ahora usa la variable 'resultados' del PriceCalculatorService #}

<div class="total_area">
    {# Las opciones de envío se mantienen igual, ya que su lógica está en el controlador y JS #}
    <ul>
        <li style="background-color: #edc898">
            <div class="row">
                <div class="col-lg-4" style="text-align: left">
                    <input id="ch_envio_expres" name="ch_envio_expres" type="checkbox"
                           class="cart-summary-updater"
                           {% if carrito.servicioExpres %}checked{% endif %}
                            {% if not empresa.servicioExpresActivo or not carrito.hasPersonalizaciones() %}disabled{% endif %}>
                    <label for="ch_envio_expres" title="Entrega en 7 días laborables.">Servicio Expres</label>
                </div>
                <div class="col-lg-4" style="text-align: left">
                    <input id="rb_envio_agencia" value="agencia" name="envio" type="radio"
                           class="cart-summary-updater"
                           {% if not carrito.recogerTienda %}checked{% endif %}>
                    <label for="rb_envio_agencia">Envío Estándar</label>
                </div>
                <div class="col-lg-4">
                    <input id="rb_envio_tienda" value="tienda" name="envio" type="radio"
                           class="cart-summary-updater"
                           {% if carrito.recogerTienda %}checked{% endif %}>
                    <label for="rb_envio_tienda">Recoger en Tienda</label>
                </div>
            </div>
        </li>
    </ul>

    {# ¡INICIO DE LA CORRECCIÓN! Usamos la variable 'resultados' si existe #}
    {% if resultados is not null %}
        {# 1. Definimos los costes adicionales (ya vienen del controlador) #}
        {% set coste_envio = precioGastos|default(0) %}
        {% set coste_expres = carrito.servicioExpres ? empresa.precioServicioExpres : 0 %}

        {# 2. Calculamos los totales a partir de los datos del servicio #}
        {% set base_imponible = resultados.subtotal_sin_iva + coste_envio + coste_expres %}
        {% set iva_a_aplicar = base_imponible * (resultados.iva_aplicado / 100) %}
        {% set total_final = base_imponible + iva_a_aplicar %}

        <ul>
            {# Mostramos el subtotal de productos + personalizaciones #}
            <li>Sub Total <span>{{ resultados.subtotal_sin_iva|number_format(2, ',', '.') }}€</span></li>

            {% if not carrito.recogerTienda %}
                <li>
                    {% if zonasEnvio is defined %}
                        <select class="form-control chosen-select cart-summary-updater" name="zonaEnvio" id="zonaEnvio"
                                style="width: 50%; display: inline">
                            {% for zona in zonasEnvio %}
                                <option value="{{ zona.id }}"
                                        {% if zonaEnvioSeleccionada is defined and zonaEnvioSeleccionada == zona.id %}selected{% endif %}>{{ zona }}</option>
                            {% endfor %}
                        </select>
                    {% endif %}
                    {% if coste_envio == 0 and zonaEnvioSeleccionada is defined and zonaEnvioSeleccionada != "1" %}
                        <span>Consultar</span>
                    {% else %}
                        <span>{{ coste_envio|number_format(2, ',', '.') }}€</span>
                    {% endif %}
                </li>
            {% endif %}

            {% if carrito.servicioExpres %}
                <li>Servicio Expres<span>{{ coste_expres|number_format(2, ',', '.') }}€</span></li>
            {% endif %}

            <li>IVA a aplicar ({{ resultados.iva_aplicado }}
                %)<span>{{ iva_a_aplicar|number_format(2, ',', '.') }} €</span></li>

            <li>Total <span style="font-size: 16px"><b>{{ total_final|number_format(2, ',', '.') }}€</b></span></li>
        </ul>
    {% endif %}
    {# --- FIN DE LA CORRECCIÓN --- #}

    <div style="text-align: right">
        {# MIGRACIÓN: Se actualizan todas las rutas #}
        <a class="btn btn-default check_out" style="background-color: red"
           href="{{ path('app_cart_clear', {'_locale': app.request.locale}) }}">
            {% trans %}Vaciar Carrito{% endtrans %}
        </a>
        {% if is_granted('ROLE_ADMIN') %}
            <a class="btn btn-default check_out"
               href="{{ path('app_cart_download_pdf', {'_locale': app.request.locale}) }}" target="_blank">Imprimir
                PDF</a>
        {% endif %}
        <a class="btn btn-default check_out" href="{{ path('app_home', {'_locale': app.request.locale}) }}">
            {% trans %}Seguir Comprando{% endtrans %}
        </a>
        <input id="confirmarPedidogtag" type="submit" class="btn btn-default check_out"
               style="background-color: #ff9000" value="{% if editing_order_id is defined and editing_order_id %}
                                                Guardar Cambios en el Pedido
                                            {% else %}
                                                Confirmar Pedido
                                            {% endif %}">
    </div>
</div>

{# MIGRACIÓN: El JavaScript ahora es más limpio y usa una única llamada AJAX #}
<script>
    $(document).ready(function () {
        // Se define la función una sola vez
        function updateCartSummary() {
            const data = {
                zonaEnvio: $('#zonaEnvio').val(),
                servicioExpres: $('#ch_envio_expres').is(':checked'),
                tienda: $('#rb_envio_tienda').is(':checked')
            };

            // Se hace una única llamada AJAX a la nueva ruta
            $('#resumen_pedido').load("{{ path('app_cart_update_summary', {'_locale': app.request.locale}) }}", data);
        }

        // Se asigna el mismo listener a todos los elementos que deben actualizar el resumen
        $('.cart-summary-updater').on('change', updateCartSummary);
    });
</script>
