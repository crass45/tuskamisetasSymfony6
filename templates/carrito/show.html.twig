{# MIGRACIÓN: Se actualiza la ruta de la plantilla de la que hereda #}
{% extends "carrito/layout.html.twig" %}

{% block title %}Carrito de la Compra{% endblock %}
{% block metaDescription %}Revisa los artículos de tu carrito de la compra y finaliza tu presupuesto.{% endblock %}

{% block cuerpoProceso %}
    {# --- INICIO DE LA MEJORA --- #}
    {# Se muestra un aviso si estamos en modo edición #}
    {% if editing_order_id is defined and editing_order_id %}
        <div class="alert alert-warning">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Modo Edición:</strong> Estás modificando el pedido <strong>#{{ editing_order_id }}</strong>.
            Cualquier cambio que realices y confirmes se guardará sobre el pedido original.
        </div>
    {% endif %}
    {# --- FIN DE LA MEJORA --- #}
    <br>
    <div class="carrito col-lg-12">
        <section id="cart_items">
            {#            <div class="container"> #}
            {# MIGRACIÓN: Se actualiza la ruta de la plantilla incluida #}
            {# La crearemos en el siguiente paso #}
            {% include 'carrito/partials/_cart_details.html.twig' %}
            {#            </div> #}
        </section> <!--/#cart_items-->

        {% if carrito is not null and carrito.items is not empty %}
            <section id="do_action">
                <div class="container">
                    <br>
                    {# Se cambia la acción del formulario si estamos en modo edición #}
                    {% set form_action = (editing_order_id is defined and editing_order_id)
                        ? path('app_cart_save_edited_order')
                        : path('app_checkout_start', {'_locale': app.request.locale}) %}
                    <form action="{{ form_action }}" method="post">

                        <div class="row">
                            <div class="col-sm-5">
                                <label for="pedidoObservaciones">Observaciones:</label>
                                <textarea id="pedidoObservaciones" name="pedidoObservaciones"
                                          style="width: 100%;min-height: 180px;"
                                          placeholder="{% trans %}Indica aquí si lo deseas observaciones acerca del pedido{% endtrans %}"></textarea>
                            </div>
                            <div class="col-sm-7" id="resumen_pedido">
                                {% include 'carrito/partials/_cart_summary.html.twig' %}
                            </div>
                        </div>
                    </form>
                </div>
            </section><!--/#do_action-->
        {% endif %}
    </div>

    {# MIGRACIÓN: El script de Google Analytics se mantiene, pero la lógica de precios
       debe ser adaptada para usar el nuevo objeto Carrito/Presupuesto #}
    <script>
        $(window).ready(function () {
            $('#carropaso2').css('color', 'black');
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Función de validación de stock
            function validateStock(input) {
                let value = parseInt(input.value) || 0;
                const maxStock = parseInt(input.getAttribute('data-max'));

                // EXCEPCIÓN: Si el stock es exactamente 500, no hay límite
                if (maxStock === 500) {
                    return true;
                }

                if (value > maxStock) {
                    alert("Lo sentimos, solo disponemos de " + maxStock + " unidades en stock.");
                    input.value = maxStock;
                    return false;
                }
                return true;
            }

            // 1. Controlar cambios manuales en el input
            document.querySelectorAll('.cart_quantity_input').forEach(function (input) {
                input.addEventListener('change', function () {
                    if (validateStock(this)) {
                        // Si es válido, redirigir para actualizar (tu lógica actual)
                        const itemIndex = this.dataset.itemIndex;
                        const productIndex = this.dataset.productIndex;
                        const quantity = this.value;

                        console.warn(itemIndex);
                        console.warn(productIndex);
                        console.warn(quantity);
                        // Construir URL de actualización (ajusta la ruta según tu router)
                        // Ejemplo: /es/carrito/update-quantity/0/0/5
                        // Generamos una URL válida con valores dummy (0, 0, 0) que luego reemplazaremos
                        let urlTemplate = "{{ path('app_cart_update_quantity', {'itemIndex': 999999, 'productIndex': 888888, 'quantity': 777777}) }}";

// En JS:
                        let url = urlTemplate.replace('999999', itemIndex)
                            .replace('888888', productIndex)
                            .replace('777777', quantity);

                        window.location.href = url;
                    }
                });
            });

            // 2. Controlar botones de sumar (+)
            document.querySelectorAll('.cart_quantity_up').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    const input = this.closest('.cart_quantity_button').querySelector('.cart_quantity_input');
                    let currentValue = parseInt(input.value) || 0;
                    const maxStock = parseInt(input.getAttribute('data-max'));

                    // Si no es la excepción de 500 y vamos a superar el stock...
                    if (maxStock !== 500 && (currentValue + 1) > maxStock) {
                        e.preventDefault(); // Evitamos que el enlace funcione
                        alert("No puedes añadir más cantidad. Stock máximo: " + maxStock);
                    }
                    // Si todo bien, dejamos que el enlace haga su redirección normal
                });
            });
        });


        // El resto de tu JavaScript para Google Analytics se puede conservar aquí,
        // asegurándote de que las variables como 'carrito' y 'producto'
        // se acceden correctamente según la nueva estructura de los objetos.


    </script>
{% endblock %}
