{# MIGRACIÓN: Se actualiza la ruta de la plantilla de la que hereda #}
{% extends "carrito/layout.html.twig" %}

{% block title %}Carrito de la Compra{% endblock %}
{% block metaDescription %}Revisa los artículos de tu carrito de la compra y finaliza tu presupuesto.{% endblock %}

{% block cuerpoProceso %}
    {# --- INICIO DE LA MEJORA --- #}
    {# Se muestra un aviso si estamos en modo edición #}
    {% if editing_order_id is defined and editing_order_id %}
        <div class="alert alert-warning">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Modo Edición:</strong> Estás modificando el pedido <strong>#{{ editing_order_id }}</strong>.
            Cualquier cambio que realices y confirmes se guardará sobre el pedido original.
        </div>
    {% endif %}
    {# --- FIN DE LA MEJORA --- #}
    <br>
    <div class="carrito col-lg-12">
        <section id="cart_items">
            <div class="container">
                {# MIGRACIÓN: Se actualiza la ruta de la plantilla incluida #}
                {# La crearemos en el siguiente paso #}
                {% include 'carrito/partials/_cart_details.html.twig' %}
            </div>
        </section> <!--/#cart_items-->

        {% if carrito is not null and carrito.items is not empty %}
            <section id="do_action">
                <div class="container">
                    <br>
                    {# Se cambia la acción del formulario si estamos en modo edición #}
                    {% set form_action = (editing_order_id is defined and editing_order_id)
                        ? path('app_cart_save_edited_order')
                        : path('app_checkout_start', {'_locale': app.request.locale})
                    %}
                    <form action="{{ form_action }}" method="post">

                        <div class="row">
                            <div class="col-sm-5">
                                <label for="pedidoObservaciones">Observaciones:</label>
                                <textarea id="pedidoObservaciones" name="pedidoObservaciones"
                                          style="width: 100%;min-height: 180px;"
                                          placeholder="{% trans %}Indica aquí si lo deseas observaciones acerca del pedido{% endtrans %}"></textarea>
                            </div>
                            <div class="col-sm-7" id="resumen_pedido">
                                {% include 'carrito/partials/_cart_summary.html.twig' %}
                            </div>
                        </div>
                    </form>
                </div>
            </section><!--/#do_action-->
        {% endif %}
    </div>

    {# MIGRACIÓN: El script de Google Analytics se mantiene, pero la lógica de precios
       debe ser adaptada para usar el nuevo objeto Carrito/Presupuesto #}
    <script>
        $(window).ready(function () {
            $('#carropaso2').css('color', 'black');
        });

        // El resto de tu JavaScript para Google Analytics se puede conservar aquí,
        // asegurándote de que las variables como 'carrito' y 'producto'
        // se acceden correctamente según la nueva estructura de los objetos.
    </script>
{% endblock %}
